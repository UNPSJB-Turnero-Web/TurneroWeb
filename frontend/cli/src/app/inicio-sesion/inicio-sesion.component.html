<div class="login-page-wrapper" [@fadeIn]>
  <!-- Header con marca -->
  <div class="login-page-header" [@slideUp]>
    <div class="brand-logo" [@logoWave]>
      <span class="material-symbols-outlined brand-icon">event_available</span>
      <h1>CheTurno</h1>
    </div>
  </div>

  <!-- Card de Login centrado -->
  <div class="login-page-content">
    <div class="card login-card" [@slideUp]>
      
      <!-- Link de registro -->
      <div class="register-prompt">
        <p class="text-small">
          ¿Nuevo en CheTurno?
          <a [@pulse]="pulseState" (click)="navigateToRegister()">Crear cuenta</a>
        </p>
      </div>
      
      <form #loginForm="ngForm" (ngSubmit)="handleSubmit(loginForm)" novalidate>
        
        <!-- PASO 1: Ingreso de Email -->
        <div *ngIf="currentStep === 'email'" class="login-step">
          <h3>Inicia sesión en tu cuenta</h3>
          
          <!-- Mensaje de error general -->
          <div class="alert-error" *ngIf="showEmailError">
            <span class="material-symbols-outlined">error</span>
            <span>No encontramos una cuenta con ese email.</span>
          </div>

          <div class="form-group">
            <label for="email" class="form-label">
              <span class="material-symbols-outlined">email</span>
              E-Mail
            </label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              [class.is-invalid]="email.invalid && email.touched"
              [(ngModel)]="loginData.email"
              required
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
              placeholder="tu@email.com"
              title="Ingresa un email válido"
              #email="ngModel"
              (input)="clearEmailErrors()"
              autocomplete="username"
            />
            <small class="invalid-feedback" *ngIf="email.invalid && email.touched">
              Ingresa un email válido
            </small>
          </div>

          <div class="checkbox-group">
            <input 
              type="checkbox" 
              id="rememberMe" 
              name="rememberMe" 
              [(ngModel)]="loginData.rememberMe"
            />
            <label for="rememberMe">Mantener sesión iniciada</label>
          </div>

          <div class="form-link-center">
            <button type="button" class="btn-link" (click)="forgotEmail()">
              ¿Olvidaste tu email?
            </button>
          </div>

          <button 
            type="submit" 
            class="btn btn-primary btn-full-width"
            [disabled]="isLoading || email.invalid"
          >
            <span class="material-symbols-outlined" *ngIf="!isLoading">arrow_forward</span>
            <span class="material-symbols-outlined spinner" *ngIf="isLoading">sync</span>
            {{ isLoading ? 'Verificando...' : 'Continuar' }}
          </button>

          <div class="divider">
            <span>o</span>
          </div>

          <asl-google-signin-button 
            type='standard' 
            size='large' 
            theme='outline' 
            shape='rectangular' 
            text='signin_with'>
          </asl-google-signin-button>
        </div>

        <!-- PASO 2: Ingreso de Contraseña -->
        <div *ngIf="currentStep === 'password'" class="login-step">
          <h3>Ingresa tu contraseña</h3>
          
          <!-- Campo oculto de email para autocompletado de Firefox/Chrome -->
          <input
            type="email"
            name="username"
            [(ngModel)]="loginData.email"
            autocomplete="username"
            style="display: none;"
            tabindex="-1"
            aria-hidden="true"
          />
          
          <!-- Información de la cuenta encontrada -->
          <div class="account-card" *ngIf="userAccount">
            <div class="account-card-content">
              <span class="material-symbols-outlined account-avatar">account_circle</span>
              <div class="account-info">
                <div class="account-name">{{ userAccount.name }}</div>
                <div class="account-email text-small">{{ userAccount.email }}</div>
              </div>
            </div>
            <button type="button" class="btn-link btn-link-small" (click)="changeAccount()">
              <span class="material-symbols-outlined">swap_horiz</span>
              Cambiar cuenta
            </button>
          </div>

          <!-- Mensaje de error de contraseña -->
          <div class="alert-error" *ngIf="showPasswordError">
            <span class="material-symbols-outlined">error</span>
            <span>{{ errorMessage || "Error al iniciar sesión. Por favor, intenta nuevamente." }}</span>
          </div>

          <div class="form-group">
            <label for="password" class="form-label">
              <span class="material-symbols-outlined">lock</span>
              Contraseña
            </label>
            <div class="input-with-icon">
              <input
                [type]="showPassword ? 'text' : 'password'"
                id="password"
                name="password"
                class="form-control"
                [class.is-invalid]="password.invalid && password.touched"
                [(ngModel)]="loginData.password"
                required
                minlength="8"
                placeholder="Tu contraseña"
                title="Ingresa tu contraseña"
                #password="ngModel"
                (input)="clearPasswordErrors()"
                autocomplete="current-password"
              />
              <button type="button" class="icon-button" (click)="togglePassword()">
                <span class="material-symbols-outlined">
                  {{ showPassword ? 'visibility_off' : 'visibility' }}
                </span>
              </button>
            </div>
            <small class="invalid-feedback" *ngIf="password.invalid && password.touched">
              <span *ngIf="password.errors?.['required']">La contraseña es requerida</span>
              <span *ngIf="password.errors?.['minlength']">La contraseña debe tener al menos 8 caracteres</span>
            </small>
          </div>

          <div class="form-link-center">
            <button type="button" class="btn-link" (click)="forgotPassword()">
              ¿Olvidaste tu contraseña?
            </button>
          </div>

          <button 
            type="submit" 
            class="btn btn-primary btn-full-width"
            [disabled]="isLoading || password.invalid"
          >
            <span class="material-symbols-outlined" *ngIf="!isLoading">login</span>
            <span class="material-symbols-outlined spinner" *ngIf="isLoading">sync</span>
            {{ isLoading ? 'Iniciando sesión...' : 'Iniciar Sesión' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
