<div class="perfil-container">
  <!-- Floating Particles Background -->
  <div class="particles-bg">
    <div
      class="particle"
      *ngFor="let p of particles; let i = index"
      [style.left.px]="p.x"
      [style.top.px]="p.y"
      [style.animation-delay.s]="i * 0.3"
    ></div>
  </div>

  <!-- Header -->
  <div class="perfil-header">
    <div class="header-title">
      <div class="title-icon">
        <i class="fas fa-user-cog"></i>
      </div>
      <div class="title-content">
        <h1>Configuración de Perfil</h1>
        <p>Gestiona tu información personal y configuración de seguridad</p>
      </div>
      <button class="btn-back" (click)="volver()">
        <i class="fas fa-arrow-left"></i>
        <span>Volver al Dashboard</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Cargando información del perfil...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!cargando" class="perfil-content">
    <!-- Información Personal -->
    <div class="perfil-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-user"></i>
        </div>
        <div class="section-title">
          <h2>Información Personal</h2>
          <p>Datos básicos de tu perfil médico</p>
        </div>
      </div>

      <div class="section-content">
        <!-- Vista de Solo Lectura -->
        <div *ngIf="!editandoPerfil" class="info-grid">
          <div class="info-card">
            <label>Nombre Completo</label>
            <div class="info-value">
              <i class="fas fa-user me-2"></i>
              {{ medicoActual?.nombre || "No disponible" }}
              {{ medicoActual?.apellido || "" }}
            </div>
          </div>

          <div class="info-card">
            <label>Matrícula Profesional</label>
            <div class="info-value">
              <i class="fas fa-id-badge me-2"></i>
              {{ medicoActual?.matricula || "No disponible" }}
            </div>
          </div>

          <div class="info-card">
            <label>Especialidad(es)</label>
            <div class="info-value">
              <i class="fas fa-stethoscope me-2"></i>
              <span *ngIf="tieneEspecialidades(); else especialidadUnica">
                <span *ngFor="let esp of getEspecialidades(); let last = last">
                  {{ esp.nombre }}<span *ngIf="!last">, </span>
                </span>
              </span>
              <ng-template #especialidadUnica>
                {{ medicoActual?.especialidad?.nombre || "No especificada" }}
              </ng-template>
            </div>
          </div>

          <div class="info-card">
            <label>DNI</label>
            <div class="info-value">
              <i class="fas fa-id-card me-2"></i>
              {{ medicoActual?.dni || "No disponible" }}
            </div>
          </div>

          <div class="info-card">
            <label>Información de Contacto</label>
            <div class="info-value">
              <i class="fas fa-info-circle me-2"></i>
              Disponible en el sistema administrativo
            </div>
          </div>
        </div>

        <!-- Formulario de Edición -->
        <div *ngIf="editandoPerfil" class="edit-form">
          <form [formGroup]="perfilForm" (ngSubmit)="guardarPerfil()">
            <div class="form-grid">
              <div class="form-group">
                <label for="nombre"
                  >Nombre <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="nombre"
                  class="form-control"
                  formControlName="nombre"
                  placeholder="Ingrese su nombre"
                  [class.is-invalid]="
                    perfilForm.get('nombre')?.touched &&
                    perfilForm.get('nombre')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('nombre')?.touched &&
                    perfilForm.get('nombre')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small *ngIf="perfilForm.get('nombre')?.errors?.['required']"
                    >El nombre es obligatorio</small
                  >
                  <small *ngIf="perfilForm.get('nombre')?.errors?.['minlength']"
                    >Mínimo 2 caracteres</small
                  >
                  <small *ngIf="perfilForm.get('nombre')?.errors?.['maxlength']"
                    >Máximo 50 caracteres</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="apellido"
                  >Apellido <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="apellido"
                  class="form-control"
                  formControlName="apellido"
                  placeholder="Ingrese su apellido"
                  [class.is-invalid]="
                    perfilForm.get('apellido')?.touched &&
                    perfilForm.get('apellido')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('apellido')?.touched &&
                    perfilForm.get('apellido')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small
                    *ngIf="perfilForm.get('apellido')?.errors?.['required']"
                    >El apellido es obligatorio</small
                  >
                  <small
                    *ngIf="perfilForm.get('apellido')?.errors?.['minlength']"
                    >Mínimo 2 caracteres</small
                  >
                  <small
                    *ngIf="perfilForm.get('apellido')?.errors?.['maxlength']"
                    >Máximo 50 caracteres</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="dni">DNI <span class="required">*</span></label>
                <input
                  type="text"
                  id="dni"
                  class="form-control"
                  formControlName="dni"
                  [class.is-invalid]="
                    perfilForm.get('dni')?.touched &&
                    perfilForm.get('dni')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('dni')?.touched &&
                    perfilForm.get('dni')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small *ngIf="perfilForm.get('dni')?.errors?.['required']"
                    >El DNI es obligatorio</small
                  >
                  <small *ngIf="perfilForm.get('dni')?.errors?.['pattern']"
                    >Formato inválido (7-9 dígitos)</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="matricula"
                  >Matrícula <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="matricula"
                  class="form-control"
                  formControlName="matricula"
                  [class.is-invalid]="
                    perfilForm.get('matricula')?.touched &&
                    perfilForm.get('matricula')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('matricula')?.touched &&
                    perfilForm.get('matricula')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small
                    *ngIf="perfilForm.get('matricula')?.errors?.['required']"
                    >La matrícula es obligatoria</small
                  >
                  <small
                    *ngIf="perfilForm.get('matricula')?.errors?.['minlength']"
                    >Mínimo 3 caracteres</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="email">Email *</label>
                <input
                  type="email"
                  id="email"
                  class="form-control"
                  formControlName="email"
                  placeholder="ejemplo@correo.com"
                  [class.is-invalid]="
                    perfilForm.get('email')?.touched &&
                    perfilForm.get('email')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('email')?.touched &&
                    perfilForm.get('email')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small *ngIf="perfilForm.get('email')?.errors?.['required']"
                    >El email es obligatorio</small
                  >
                  <small *ngIf="perfilForm.get('email')?.errors?.['email']"
                    >Email inválido</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="telefono">Teléfono *</label>
                <input
                  type="text"
                  id="telefono"
                  class="form-control"
                  formControlName="telefono"
                  placeholder="+54 9 11 1234-5678"
                  [class.is-invalid]="
                    perfilForm.get('telefono')?.touched &&
                    perfilForm.get('telefono')?.invalid
                  "
                />
                <div
                  *ngIf="
                    perfilForm.get('telefono')?.touched &&
                    perfilForm.get('telefono')?.invalid
                  "
                  class="invalid-feedback"
                >
                  <small
                    *ngIf="perfilForm.get('telefono')?.errors?.['required']"
                    >El teléfono es obligatorio</small
                  >
                  <small *ngIf="perfilForm.get('telefono')?.errors?.['pattern']"
                    >Formato inválido</small
                  >
                </div>
              </div>
            </div>
          </form>

          <div class="edit-note">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Nota:</strong> Las especialidades se gestionan desde el
            panel administrativo
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="section-actions">
          <div *ngIf="!editandoPerfil">
            <button class="btn-secondary" (click)="editarPerfil()">
              <i class="fas fa-edit me-2"></i>
              Editar Información
            </button>
          </div>

          <div *ngIf="editandoPerfil" class="edit-actions">
            <button
              type="button"
              class="btn-primary"
              (click)="guardarPerfil()"
              [disabled]="!perfilForm.valid || cargandoGuardado"
            >
              <i *ngIf="!cargandoGuardado" class="fas fa-save me-2"></i>
              <i
                *ngIf="cargandoGuardado"
                class="fas fa-spinner fa-spin me-2"
              ></i>
              {{ cargandoGuardado ? "Guardando..." : "Guardar Cambios" }}
            </button>

            <button
              type="button"
              class="btn-secondary"
              (click)="cancelarEdicion()"
              [disabled]="cargandoGuardado"
            >
              <i class="fas fa-times me-2"></i>
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="perfil-section">
      <div class="section-header">
        <div class="section-icon security">
          <i class="fas fa-key"></i>
        </div>
        <div class="section-title">
          <h2>Cambio de Contraseña</h2>
          <p>Actualiza tu contraseña para mantener tu cuenta segura</p>
        </div>
      </div>

      <div class="section-content">
        <form [formGroup]="passwordForm" (ngSubmit)="cambiarPassword()">
          <div class="password-grid">
            <div class="password-field">
              <label for="currentPassword">Contraseña Actual</label>
              <div class="password-input-container">
                <input
                  id="currentPassword"
                  [type]="showCurrentPassword ? 'text' : 'password'"
                  formControlName="currentPassword"
                  class="form-control"
                  placeholder="Ingresa tu contraseña actual"
                  [class.is-invalid]="
                    passwordForm.get('currentPassword')?.invalid &&
                    passwordForm.get('currentPassword')?.touched
                  "
                />
                <button
                  type="button"
                  class="password-toggle"
                  (click)="toggleCurrentPasswordVisibility()"
                >
                  <i
                    [class]="
                      showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'
                    "
                  ></i>
                </button>
              </div>
              <div
                class="invalid-feedback"
                *ngIf="
                  passwordForm.get('currentPassword')?.invalid &&
                  passwordForm.get('currentPassword')?.touched
                "
              >
                La contraseña actual es requerida
              </div>
            </div>

            <div class="password-field">
              <label for="newPassword">Nueva Contraseña</label>
              <div class="password-input-container">
                <input
                  id="newPassword"
                  [type]="showNewPassword ? 'text' : 'password'"
                  formControlName="newPassword"
                  class="form-control"
                  placeholder="Ingresa tu nueva contraseña"
                  [class.is-invalid]="
                    passwordForm.get('newPassword')?.invalid &&
                    passwordForm.get('newPassword')?.touched
                  "
                />
                <button
                  type="button"
                  class="password-toggle"
                  (click)="toggleNewPasswordVisibility()"
                >
                  <i
                    [class]="
                      showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'
                    "
                  ></i>
                </button>
              </div>
              <div
                class="password-strength"
                *ngIf="passwordForm.get('newPassword')?.value"
              >
                <div class="strength-bar">
                  <div
                    class="strength-fill"
                    [class]="
                      'strength-' +
                      getPasswordStrength(
                        passwordForm.get('newPassword')?.value
                      )
                    "
                  ></div>
                </div>
                <small
                  class="strength-text"
                  [class]="
                    'text-' +
                    getPasswordStrength(passwordForm.get('newPassword')?.value)
                  "
                >
                  Fortaleza:
                  {{
                    getPasswordStrengthText(
                      passwordForm.get("newPassword")?.value
                    )
                  }}
                </small>
              </div>
              <div
                class="invalid-feedback"
                *ngIf="
                  passwordForm.get('newPassword')?.invalid &&
                  passwordForm.get('newPassword')?.touched
                "
              >
                <div
                  *ngIf="passwordForm.get('newPassword')?.hasError('required')"
                >
                  La nueva contraseña es requerida
                </div>
                <div
                  *ngIf="passwordForm.get('newPassword')?.hasError('minlength')"
                >
                  La contraseña debe tener al menos 8 caracteres
                </div>
                <div
                  *ngIf="passwordForm.get('newPassword')?.hasError('pattern')"
                >
                  La contraseña debe contener al menos una mayúscula, una
                  minúscula y un número
                </div>
              </div>
            </div>

            <div class="password-field">
              <label for="confirmPassword">Confirmar Nueva Contraseña</label>
              <div class="password-input-container">
                <input
                  id="confirmPassword"
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  formControlName="confirmPassword"
                  class="form-control"
                  placeholder="Confirma tu nueva contraseña"
                  [class.is-invalid]="
                    passwordForm.get('confirmPassword')?.invalid &&
                    passwordForm.get('confirmPassword')?.touched
                  "
                />
                <button
                  type="button"
                  class="password-toggle"
                  (click)="toggleConfirmPasswordVisibility()"
                >
                  <i
                    [class]="
                      showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'
                    "
                  ></i>
                </button>
              </div>
              <div
                class="invalid-feedback"
                *ngIf="
                  passwordForm.get('confirmPassword')?.invalid &&
                  passwordForm.get('confirmPassword')?.touched
                "
              >
                <div
                  *ngIf="
                    passwordForm.get('confirmPassword')?.hasError('required')
                  "
                >
                  Debes confirmar tu nueva contraseña
                </div>
                <div
                  *ngIf="
                    passwordForm.hasError('passwordMismatch') &&
                    !passwordForm.get('confirmPassword')?.hasError('required')
                  "
                >
                  Las contraseñas no coinciden
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="resetPasswordForm()"
            >
              <i class="fas fa-undo me-2"></i>
              Limpiar
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="passwordForm.invalid || cargandoCambioPassword"
            >
              <i class="fas fa-key me-2"></i>
              <span *ngIf="!cargandoCambioPassword">Cambiar Contraseña</span>
              <span *ngIf="cargandoCambioPassword">Cambiando...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Configuración de Notificaciones -->
    <div class="perfil-section">
      <div class="section-header">
        <div class="section-icon notifications">
          <i class="fas fa-bell"></i>
        </div>
        <div class="section-title">
          <h2>Notificaciones</h2>
          <p>Configura cómo quieres recibir las notificaciones</p>
        </div>
      </div>

      <div class="section-content">
        <div class="notifications-grid">
          <div class="notification-card">
            <div class="notification-info">
              <div class="notification-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="notification-details">
                <h4>Nuevos Turnos</h4>
                <p>Notificaciones cuando se asignen nuevos turnos</p>
              </div>
            </div>
            <div class="notification-toggle">
              <label class="switch">
                <input
                  type="checkbox"
                  [(ngModel)]="configuracionNotificaciones.emailTurnos"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="notification-card">
            <div class="notification-info">
              <div class="notification-icon">
                <i class="fas fa-times-circle"></i>
              </div>
              <div class="notification-details">
                <h4>Cancelaciones</h4>
                <p>Avisos cuando se cancelen turnos programados</p>
              </div>
            </div>
            <div class="notification-toggle">
              <label class="switch">
                <input
                  type="checkbox"
                  [(ngModel)]="configuracionNotificaciones.emailCancelaciones"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="notification-card">
            <div class="notification-info">
              <div class="notification-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="notification-details">
                <h4>Recordatorios</h4>
                <p>Recordatorios de turnos próximos</p>
              </div>
            </div>
            <div class="notification-toggle">
              <label class="switch">
                <input
                  type="checkbox"
                  [(ngModel)]="configuracionNotificaciones.emailRecordatorios"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="notification-card">
            <div class="notification-info">
              <div class="notification-icon">
                <i class="fas fa-sms"></i>
              </div>
              <div class="notification-details">
                <h4>SMS</h4>
                <p>Notificaciones por mensaje de texto</p>
              </div>
            </div>
            <div class="notification-toggle">
              <label class="switch">
                <input
                  type="checkbox"
                  [(ngModel)]="configuracionNotificaciones.smsNotificaciones"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="section-actions">
          <button
            class="btn-primary"
            (click)="guardarConfiguracionNotificaciones()"
          >
            <i class="fas fa-save me-2"></i>
            Guardar Configuración
          </button>
        </div>
      </div>
    </div>

    <!-- Cambio de Contraseña -->
  </div>
</div>
