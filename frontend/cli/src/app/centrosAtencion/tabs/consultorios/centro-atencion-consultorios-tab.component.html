<div class="modern-card">
  <div class="modern-card-header">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <div class="me-3">
          <i class="icon-consultorios"></i>
        </div>
        <div>
          <h4 class="mb-0 fw-bold">Gestión de Consultorios</h4>
          <small class="opacity-75">Administrar consultorios del centro de atención</small>
        </div>
      </div>
      <div *ngIf="!modoCrearConsultorio" class="d-flex gap-2">
        <button class="btn-modern btn-success-modern" (click)="onModoCrearConsultorio()">
          <i class="fa fa-plus me-2"></i> Nuevo Consultorio
        </button>
        <button class="btn-modern btn-primary-modern" (click)="onCrearNuevoConsultorio()">
          <i class="fa fa-external-link me-2"></i> Formulario Completo
        </button>
      </div>
    </div>
  </div>
  
  <div class="modern-card-body">
    <!-- Alert Messages -->
    <div *ngIf="mensajeConsultorio" class="modern-alert" 
         [class.alert-success]="tipoMensajeConsultorio === 'success'"
         [class.alert-danger]="tipoMensajeConsultorio === 'danger'"
         [class.alert-info]="tipoMensajeConsultorio === 'info'">
      <i class="fa" [class.fa-check-circle]="tipoMensajeConsultorio === 'success'"
         [class.fa-exclamation-triangle]="tipoMensajeConsultorio === 'danger'"
         [class.fa-info-circle]="tipoMensajeConsultorio === 'info'" me-2></i>
      {{ mensajeConsultorio }}
    </div>
    
    <!-- Create New Consultorio Form -->
    <div *ngIf="modoCrearConsultorio" class="mb-4 p-4" style="background: rgba(54, 185, 204, 0.05); border-radius: 15px; border: 2px solid rgba(54, 185, 204, 0.2);">
      <h5 class="mb-3 text-primary">
        <i class="fa fa-plus-circle me-2"></i>Crear Nuevo Consultorio
      </h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Número:</label>
          <input type="number" [(ngModel)]="nuevoConsultorio.numero" name="numeroConsultorio"
                 class="form-control-modern" placeholder="Número del consultorio">
        </div>
        <div class="col-md-8">
          <label class="form-label fw-semibold">Nombre:</label>
          <input type="text" [(ngModel)]="nuevoConsultorio.nombre" name="nombreConsultorio"
                 class="form-control-modern" placeholder="Nombre descriptivo del consultorio">
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn-modern btn-success-modern" (click)="onCrearConsultorio()"
                [disabled]="!nuevoConsultorio.numero || !nuevoConsultorio.nombre">
          <i class="fa fa-save me-2"></i> Crear
        </button>
        <button class="btn-modern btn-secondary-modern" (click)="onCancelarCrearConsultorio()">
          <i class="fa fa-times me-2"></i> Cancelar
        </button>
      </div>
    </div>
    
    <!-- Consultorios Table -->
    <div *ngIf="consultorios.length > 0; else noConsultorios">
      <div class="modern-table">
        <table class="table mb-0">
          <thead>
            <tr>
              <th width="5%">
                <div class="d-flex align-items-center">
                  <i class="fa fa-chevron-right"></i>
                </div>
              </th>
              <th width="15%">
                <div class="d-flex align-items-center">
                  <i class="fa fa-hashtag me-2"></i>
                  Número
                </div>
              </th>
              <th width="60%">
                <div class="d-flex align-items-center">
                  <i class="fa fa-building me-2"></i>
                  Nombre
                </div>
              </th>
              <th width="20%">
                <div class="d-flex align-items-center">
                  <i class="fa fa-cogs me-2"></i>
                  Acciones
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let consultorio of consultorios; let i = index">
              <!-- Fila Principal del Consultorio -->
              <tr class="consultorio-row" 
                  [class.expanded]="consultorioExpandido[consultorio.id || 0]"
                  (click)="onToggleConsultorioExpansion(consultorio)">
                <td>
                  <button class="btn btn-link p-0 text-primary" 
                          [class.rotated]="consultorioExpandido[consultorio.id || 0]">
                    <i class="fa fa-chevron-right transition-all"></i>
                  </button>
                </td>
                <td>
                  <span class="badge badge-primary">
                    <i class="fa fa-hashtag me-1"></i>{{ consultorio.numero }}
                  </span>
                </td>
                <td>
                  <div class="d-flex justify-content-between align-items-center">
                    <div *ngIf="editConsultorioIndex !== i">
                      <div class="d-flex align-items-center">
                        <i class="fa fa-building me-2"></i>
                        <strong>{{ consultorio.nombre }}</strong>
                      </div>
                    </div>
                    <div *ngIf="editConsultorioIndex === i" class="w-100">
                      <input [(ngModel)]="consultorio.nombre" 
                             class="form-control"
                             (click)="$event.stopPropagation()">
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <button *ngIf="editConsultorioIndex !== i" 
                            class="btn btn-sm btn-outline-primary" 
                            (click)="onEditarConsultorio(i); $event.stopPropagation()"
                            title="Editar consultorio">
                      <i class="fa fa-pencil"></i>
                    </button>
                    <button *ngIf="editConsultorioIndex !== i" 
                            class="btn btn-sm btn-outline-info" 
                            (click)="onEditarHorariosConsultorio(consultorio); $event.stopPropagation()"
                            title="Gestionar horarios de atención">
                      <i class="fa fa-clock"></i>
                    </button>
                    <button *ngIf="editConsultorioIndex === i" 
                            class="btn btn-sm btn-outline-success" 
                            (click)="onGuardarEdicionConsultorio(i); $event.stopPropagation()"
                            title="Guardar cambios">
                      <i class="fa fa-save"></i>
                    </button>
                    <button *ngIf="editConsultorioIndex === i" 
                            class="btn btn-sm btn-outline-secondary" 
                            (click)="onCancelarEdicionConsultorio(); $event.stopPropagation()"
                            title="Cancelar edición">
                      <i class="fa fa-times"></i>
                    </button>
                    <button *ngIf="editConsultorioIndex !== i" 
                            class="btn btn-sm btn-outline-danger" 
                            (click)="onEliminarConsultorio(consultorio); $event.stopPropagation()"
                            title="Eliminar consultorio">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              
              <!-- Fila Expandible - Detalles del Consultorio -->
              <tr *ngIf="consultorioExpandido[consultorio.id || 0]" class="expansion-row">
                <td colspan="4" class="p-0">
                  <div class="expansion-content p-4">
                    <div class="row g-4">
                      
                      <!-- Panel de Horarios -->
                      <div class="col-12">
                        <div class="card">
                          <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                              <i class="fa fa-clock me-2"></i>
                              Horarios de Atención
                            </h6>
                          </div>
                          <div class="card-body">
                            <!-- Horarios por Defecto -->
                            <div *ngIf="consultorio.horaAperturaDefault && consultorio.horaCierreDefault" class="mb-3">
                              <div class="d-flex align-items-center mb-2">
                                <i class="fa fa-clock text-primary me-2"></i>
                                <strong>Horario General:</strong>
                              </div>
                              <div class="default-schedule-display">
                                {{ consultorio.horaAperturaDefault }} - {{ consultorio.horaCierreDefault }}
                              </div>
                            </div>
                            
                            <!-- Horarios Semanales Detallados -->
                            <div *ngIf="consultorio.horariosSemanales && consultorio.horariosSemanales.length > 0">
                              <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="text-info mb-0">
                                  <i class="fa fa-calendar me-2"></i>Horarios Específicos por Día
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" 
                                        (click)="onEditarHorariosConsultorio(consultorio)"
                                        title="Editar horarios del consultorio">
                                  <i class="fa fa-edit me-1"></i>Editar
                                </button>
                              </div>
                              <div class="calendario-horarios-consultorio">
                                <div class="table-responsive">
                                  <table class="table table-horarios-semanal w-100">
                                  <!-- Headers de días -->
                                  <thead>
                                    <tr>
                                      <th *ngFor="let dia of ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM']" 
                                          class="dia-header-horarios">
                                        {{ dia }}
                                      </th>
                                    </tr>
                                  </thead>
                                  <!-- Cuerpo con horarios -->
                                  <tbody>
                                    <tr>
                                      <td *ngFor="let dia of ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO']" 
                                          class="horario-celda">
                                        <ng-container *ngFor="let horario of consultorio.horariosSemanales">
                                          <div *ngIf="horario.diaSemana.toUpperCase() === dia" 
                                               class="horario-card" 
                                               [class.activo]="horario.activo"
                                               [class.cerrado]="!horario.activo">
                                            <div class="horario-status">
                                              <i class="fa" [class.fa-check-circle]="horario.activo" 
                                                 [class.fa-times-circle]="!horario.activo"
                                                 [class.text-success]="horario.activo"
                                                 [class.text-danger]="!horario.activo"></i>
                                            </div>
                                            <div class="horario-time" *ngIf="horario.activo">
                                              <div class="time-range">
                                                <i class="fa fa-clock me-1"></i>
                                                <span>{{ horario.horaApertura ? horario.horaApertura.substring(0,5) : '' }}</span>
                                              </div>
                                              <div class="time-separator">-</div>
                                              <div class="time-range">
                                                <span>{{ horario.horaCierre ? horario.horaCierre.substring(0,5) : '' }}</span>
                                              </div>
                                            </div>
                                            <div class="horario-closed" *ngIf="!horario.activo">
                                              <i class="fa fa-ban me-1"></i>
                                              <span>Cerrado</span>
                                            </div>
                                          </div>
                                        </ng-container>
                                        
                                        <!-- Mostrar horario default si no hay específico -->
                                        <div *ngIf="!getHorarioEspecifico(consultorio, dia) && consultorio.horaAperturaDefault" 
                                             class="horario-card default">
                                          <div class="horario-status">
                                            <i class="fa fa-info-circle text-info"></i>
                                          </div>
                                          <div class="horario-time">
                                            <div class="time-range">
                                              <i class="fa fa-clock me-1"></i>
                                              <span>{{ consultorio.horaAperturaDefault ? consultorio.horaAperturaDefault.substring(0,5) : '' }}</span>
                                            </div>
                                            <div class="time-separator">-</div>
                                            <div class="time-range">
                                              <span>{{ consultorio.horaCierreDefault ? consultorio.horaCierreDefault.substring(0,5) : '' }}</span>
                                            </div>
                                          </div>
                                          <div class="horario-default-label">
                                            <small>General</small>
                                          </div>
                                        </div>
                                        
                                        <!-- Sin horario configurado -->
                                        <div *ngIf="!getHorarioEspecifico(consultorio, dia) && !consultorio.horaAperturaDefault" 
                                             class="horario-vacio">
                                          <div class="horario-vacio-content">
                                            <i class="fa fa-calendar-times"></i>
                                            <span>Sin configurar</span>
                                          </div>
                                        </div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Mensaje si no hay horarios configurados -->
                            <div *ngIf="!consultorio.horaAperturaDefault && !consultorio.horariosSemanales?.length" 
                                 class="text-muted text-center py-3">
                              <i class="fa fa-clock-o fa-2x mb-2 d-block"></i>
                              Sin horarios configurados
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Panel de Esquemas de Turno -->
                      <div class="col-12">
                        <div class="card">
                          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                              <i class="fa fa-calendar-check me-2"></i>
                              Esquemas de Turnos
                            </h6>
                            <button class="btn btn-sm btn-light" 
                                    (click)="onCrearNuevoEsquema(consultorio)"
                                    title="Crear nuevo esquema de turno para este consultorio">
                              <i class="fa fa-plus me-1"></i>Nuevo Esquema
                            </button>
                          </div>
                          <div class="card-body">
                            <!-- Tabla calendario semanal para el consultorio -->
                            <div *ngIf="getEsquemasDelConsultorio(consultorio.id!).length > 0; else noEsquemasConsultorio">
                              <div class="calendario-semanal-consultorio">
                                <div class="table-responsive">
                                  <table class="table table-calendario-semanal w-100">
                                  <!-- Headers de días -->
                                  <thead>
                                    <tr>
                                      <th *ngFor="let dia of ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM']" 
                                          class="dia-header-table">
                                        {{ dia }}
                                      </th>
                                    </tr>
                                  </thead>
                                  <!-- Cuerpo con esquemas -->
                                  <tbody>
                                    <tr>
                                      <td *ngFor="let dia of ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO']" 
                                          class="dia-celda">
                                        <!-- Esquemas del día -->
                                        <div *ngFor="let esquema of getEsquemasDelConsultorioPorDia(consultorio.id!, dia)" 
                                             class="esquema-card-semanal"
                                             [style.border-left-color]="getColorBorde(dia)">
                                          <div class="medico-info-card">
                                            <i class="fa fa-user-md me-1"></i>
                                            <span class="medico-nombre-card">{{ esquema.nombreStaffMedico || 'N/A' }}</span>
                                          </div>
                                          <div class="horarios-card">
                                            <div *ngFor="let horario of getHorariosPorDia(esquema, dia)" 
                                                 class="horario-item-card">
                                              <i class="fa fa-clock me-1"></i>
                                              <span>{{ horario.horaInicio.substring(0,5) }}-{{ horario.horaFin.substring(0,5) }}</span>
                                            </div>
                                          </div>
                                          <div class="actions-card">
                                            <button class="btn btn-xs btn-outline-primary" 
                                                    (click)="onVerDetalleEsquema(esquema)"
                                                    title="Ver detalle del esquema">
                                              <i class="fa fa-eye"></i>
                                            </button>
                                            <button class="btn btn-xs btn-outline-success" 
                                                    (click)="onEditarEsquema(esquema)"
                                                    title="Editar esquema">
                                              <i class="fa fa-edit"></i>
                                            </button>
                                          </div>
                                        </div>
                                        
                                        <!-- Placeholder cuando no hay esquemas para este día -->
                                        <div *ngIf="getEsquemasDelConsultorioPorDia(consultorio.id!, dia).length === 0" 
                                             class="dia-libre">
                                          <div class="dia-libre-content">
                                            <i class="fa fa-calendar-o"></i>
                                            <span>Libre</span>
                                          </div>
                                        </div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Estado cuando no hay esquemas -->
                            <ng-template #noEsquemasConsultorio>
                              <div class="text-center py-4">
                                <i class="fa fa-calendar-plus fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted mb-2">Sin esquemas configurados</h6>
                                <p class="text-muted mb-3">
                                  Este consultorio no tiene esquemas de turno asignados.
                                </p>
                                <button class="btn btn-primary" 
                                        (click)="onCrearNuevoEsquema(consultorio)">
                                  <i class="fa fa-plus me-2"></i>Crear Primer Esquema
                                </button>
                              </div>
                            </ng-template>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
    
    <ng-template #noConsultorios>
      <div class="text-center py-5" style="opacity: 0.7;">
        <i class="fa fa-stethoscope" style="font-size: 3rem; color: #36b9cc; margin-bottom: 1rem;"></i>
        <h5>No hay consultorios registrados</h5>
        <p class="text-muted">Agregue el primer consultorio para este centro de atención</p>
      </div>
    </ng-template>
  </div>
</div>
