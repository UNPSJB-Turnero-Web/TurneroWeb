<div class="container-fluid px-3 py-4">
  <!-- HEADER NORMALIZADO CON SISTEMA DE COLORES -->
  <div
    class="banner-pacientes d-flex align-items-center justify-content-between mb-4"
  >
    <div class="title-section d-flex align-items-center">
      <div class="header-icon me-3">
        <i class="fas fa-user-injured"></i>
      </div>
      <div>
        <h1 class="mb-0 fw-bold">Pacientes</h1>
        <p class="mb-0 opacity-75">Gestión de pacientes registrados</p>
      </div>
    </div>
    <button class="btn-new" (click)="router.navigate(['/pacientes/new'])">
      <i class="fas fa-plus me-2"></i>
      <span class="d-none d-sm-inline">Nuevo Paciente</span>
    </button>
  </div>

  <!-- BARRA DE BÚSQUEDA Y FILTROS -->
  <div class="search-filters-card mb-4">
    <div class="row g-3">
      <!-- Búsqueda unificada por nombre o apellido -->
      <div class="col-md-4">
        <label for="nombreApellidoFilter" class="form-label fw-semibold">
          <i class="fas fa-user me-1 text-pacientes"></i>Nombre o Apellido
        </label>
        <input
          type="text"
          id="nombreApellidoFilter"
          class="form-control"
          placeholder="Buscar por nombre o apellido..."
          [(ngModel)]="filters.nombreApellido"
          (input)="onFilterChange()"
          autocomplete="off"
        />
      </div>

      <!-- Búsqueda por documento -->
      <div class="col-md-4">
        <label for="documentoFilter" class="form-label fw-semibold">
          <i class="fas fa-id-card me-1 text-pacientes"></i>DNI/Documento
        </label>
        <input
          type="text"
          id="documentoFilter"
          class="form-control"
          placeholder="Buscar por documento..."
          [(ngModel)]="filters.documento"
          (input)="onFilterChange()"
          autocomplete="off"
        />
      </div>

      <!-- Búsqueda por email -->
      <div class="col-md-4">
        <label for="emailFilter" class="form-label fw-semibold">
          <i class="fas fa-envelope me-1 text-pacientes"></i>Email
        </label>
        <input
          type="email"
          id="emailFilter"
          class="form-control"
          placeholder="Buscar por email..."
          [(ngModel)]="filters.email"
          (input)="onFilterChange()"
          autocomplete="off"
        />
      </div>
    </div>

    <!-- Fila adicional para controles -->
    <div class="row g-3 mt-2">
      <div class="col-md-3">
        <label class="form-label fw-semibold">
          <i class="fas fa-list me-1 text-pacientes"></i>Registros por página
        </label>
        <select
          class="form-select"
          [(ngModel)]="pageSize"
          (change)="onPageSizeChange()"
        >
          <option [value]="10">10 registros</option>
          <option [value]="25">25 registros</option>
          <option [value]="50">50 registros</option>
          <option [value]="100">100 registros</option>
        </select>
      </div>

      <div class="col-md-6 d-flex align-items-end">
        <div class="d-flex gap-2 w-100">
          <button
            class="btn btn-outline-secondary flex-fill"
            (click)="clearFilters()"
            [disabled]="!hasActiveFilters()"
          >
            <i class="fas fa-times me-1"></i>Limpiar filtros
          </button>
          <button
            class="btn btn-pacientes flex-fill"
            (click)="refreshData()"
            [disabled]="isLoading"
          >
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoading"></i>
            Actualizar
          </button>
        </div>
      </div>
    </div>

    <!-- Información de resultados -->
    <div class="row mt-3" *ngIf="resultsPage.totalElements > 0">
      <div class="col-12">
        <div class="results-info text-muted small">
          <i class="fas fa-info-circle me-1"></i>
          Mostrando {{ resultsPage.numberOfElements }} de
          {{ resultsPage.totalElements }} pacientes
          <span *ngIf="hasActiveFilters()" class="ms-2">
            (filtrados de {{ totalUnfiltered }} registros totales)
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA MODERNA CON SISTEMA GLOBAL -->
  <div class="modern-table">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th class="border-0 py-3 ps-4">
            <div class="header-cell">
              <div class="icon-circle id-header">
                <i class="fas fa-hashtag"></i>
              </div>
              <span>ID</span>
            </div>
          </th>
          <th class="border-0 py-3 sortable-header" (click)="sortBy('nombre')">
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-user"></i>
              </div>
              <span>Nombre</span>
              <i
                class="fas fa-sort sort-icon ms-2"
                [class.fa-sort-up]="
                  sortConfig.field === 'nombre' &&
                  sortConfig.direction === 'asc'
                "
                [class.fa-sort-down]="
                  sortConfig.field === 'nombre' &&
                  sortConfig.direction === 'desc'
                "
              ></i>
            </div>
          </th>
          <th
            class="border-0 py-3 sortable-header"
            (click)="sortBy('apellido')"
          >
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-user-tag"></i>
              </div>
              <span>Apellido</span>
              <i
                class="fas fa-sort sort-icon ms-2"
                [class.fa-sort-up]="
                  sortConfig.field === 'apellido' &&
                  sortConfig.direction === 'asc'
                "
                [class.fa-sort-down]="
                  sortConfig.field === 'apellido' &&
                  sortConfig.direction === 'desc'
                "
              ></i>
            </div>
          </th>
          <th class="border-0 py-3 sortable-header" (click)="sortBy('email')">
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-envelope"></i>
              </div>
              <span>Email</span>
              <i
                class="fas fa-sort sort-icon ms-2"
                [class.fa-sort-up]="
                  sortConfig.field === 'email' && sortConfig.direction === 'asc'
                "
                [class.fa-sort-down]="
                  sortConfig.field === 'email' &&
                  sortConfig.direction === 'desc'
                "
              ></i>
            </div>
          </th>
          <th class="border-0 py-3">
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-phone"></i>
              </div>
              <span>Teléfono</span>
            </div>
          </th>
          <th class="border-0 py-3 sortable-header" (click)="sortBy('dni')">
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-id-card"></i>
              </div>
              <span>DNI</span>
              <i
                class="fas fa-sort sort-icon ms-2"
                [class.fa-sort-up]="
                  sortConfig.field === 'dni' && sortConfig.direction === 'asc'
                "
                [class.fa-sort-down]="
                  sortConfig.field === 'dni' && sortConfig.direction === 'desc'
                "
              ></i>
            </div>
          </th>
          <th
            class="border-0 py-3 sortable-header"
            (click)="sortBy('fechaNacimiento')"
          >
            <div class="header-cell">
              <div class="icon-circle icon-pacientes">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <span>Fecha Nac.</span>
              <i
                class="fas fa-sort sort-icon ms-2"
                [class.fa-sort-up]="
                  sortConfig.field === 'fechaNacimiento' &&
                  sortConfig.direction === 'asc'
                "
                [class.fa-sort-down]="
                  sortConfig.field === 'fechaNacimiento' &&
                  sortConfig.direction === 'desc'
                "
              ></i>
            </div>
          </th>
          <th class="border-0 py-3">
            <div class="header-cell">
              <div class="icon-circle icon-obra-social">
                <i class="fas fa-hospital"></i>
              </div>
              <span>Obra Social</span>
            </div>
          </th>
          <th class="border-0 py-3 text-center">
            <div class="header-cell justify-content-center">
              <div class="icon-circle actions-header">
                <i class="fas fa-cogs"></i>
              </div>
              <span>Acciones</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <!-- Loading state -->
        <tr *ngIf="isLoading">
          <td colspan="9" class="text-center py-5">
            <div class="loading-state">
              <i class="fas fa-spinner fa-spin fa-2x text-pacientes mb-3"></i>
              <h6 class="text-muted">Cargando pacientes...</h6>
            </div>
          </td>
        </tr>

        <!-- Data rows -->
        <tr
          *ngFor="let paciente of resultsPage.content || []; let i = index"
          (click)="goToDetail(paciente.id)"
          class="hover-pacientes cursor-pointer"
        >
          <td class="ps-4 py-3">
            <span class="badge-pacientes">{{ paciente.id }}</span>
          </td>
          <td class="py-3">
            <div class="fw-medium text-dark">{{ paciente.nombre }}</div>
          </td>
          <td class="py-3">
            <div class="fw-medium text-dark">{{ paciente.apellido }}</div>
          </td>
          <td class="py-3">
            <div class="text-muted small d-flex align-items-center">
              <i class="fas fa-envelope me-2 text-pacientes"></i>
              {{ paciente.email }}
            </div>
          </td>
          <td class="py-3">
            <div class="text-muted d-flex align-items-center">
              <i class="fas fa-phone me-2 text-pacientes"></i>
              {{ paciente.telefono }}
            </div>
          </td>
          <td class="py-3">
            <span class="chip-pacientes">{{ paciente.dni }}</span>
          </td>
          <td class="py-3">
            <div class="text-muted small d-flex align-items-center">
              <i class="fas fa-calendar me-2 text-pacientes"></i>
              {{ paciente.fechaNacimiento | date : "dd/MM/yyyy" }}
            </div>
          </td>
          <td class="py-3">
            <span
              class="badge-obra-social"
              [class.chip-obra-social]="!paciente.obraSocial?.nombre"
            >
              <i class="fas fa-hospital me-1"></i>
              {{ paciente.obraSocial?.nombre || "Sin obra social" }}
            </span>
          </td>
          <td class="py-3 text-center">
            <div class="d-flex justify-content-center gap-2">
              <button
                (click)="goToEdit(paciente.id); $event.stopPropagation()"
                class="btn-action btn-edit"
                title="Editar paciente"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                (click)="confirmDelete(paciente.id); $event.stopPropagation()"
                class="btn-action btn-delete"
                title="Eliminar paciente"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>

        <!-- Empty state -->
        <tr
          *ngIf="
            !isLoading &&
            (!resultsPage.content || resultsPage.content.length === 0)
          "
        >
          <td colspan="9" class="text-center py-5">
            <div class="empty-state">
              <i class="fas fa-user-injured fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No hay pacientes registrados</h5>
              <p class="text-muted small">
                {{
                  hasActiveFilters()
                    ? "No se encontraron pacientes con los filtros aplicados"
                    : "Comience agregando un nuevo paciente al sistema"
                }}
              </p>
              <button
                *ngIf="hasActiveFilters()"
                class="btn btn-outline-primary mt-2"
                (click)="clearFilters()"
              >
                <i class="fas fa-times me-1"></i>Limpiar filtros
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- PAGINACIÓN -->
  <div class="mt-4" *ngIf="!isLoading && resultsPage.totalPages > 1">
    <app-pagination
      [totalPages]="resultsPage.totalPages"
      [currentPage]="currentPage"
      (pageChangeRequested)="onPageChangeRequested($event)"
      [number]="resultsPage.number"
      [hidden]="resultsPage.numberOfElements < 1"
    ></app-pagination>
  </div>
</div>
