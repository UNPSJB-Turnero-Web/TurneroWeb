<div class="container-fluid px-3 py-4" *ngIf="paciente">
  <div class="card shadow-lg rounded-4 overflow-hidden border-0">
    <!-- Header con gradiente verde-esmeralda -->
    <div
      class="card-header bg-gradient-green text-white position-relative py-4 px-5"
    >
      <div class="gradient-overlay"></div>
      <div class="position-relative">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <div class="icon-container me-4">
              <i class="fas fa-user-injured icon-main"></i>
            </div>
            <div>
              <h1 class="mb-1 fw-bold display-6" *ngIf="!esNuevo()">
                {{ paciente.nombre }} {{ paciente.apellido }}
              </h1>
              <h1 class="mb-1 fw-bold display-6" *ngIf="esNuevo()">
                Nuevo Paciente
              </h1>
              <p class="mb-0 opacity-75">
                <ng-container *ngIf="!modoEdicion && !esNuevo()"
                  >Información del paciente</ng-container
                >
                <ng-container *ngIf="modoEdicion && !esNuevo()"
                  >Editando información</ng-container
                >
                <ng-container *ngIf="esNuevo()"
                  >Registro de nuevo paciente</ng-container
                >
              </p>
            </div>
          </div>
          <div class="d-flex gap-2" *ngIf="!modoEdicion && !esNuevo()">
            <button
              class="btn btn-glass rounded-pill px-4"
              (click)="activarEdicion()"
            >
              <i class="fas fa-edit me-2"></i>
              <span class="d-none d-sm-inline">Editar</span>
            </button>
            <button
              class="btn btn-glass-secondary rounded-pill px-4"
              (click)="goBack()"
            >
              <i class="fas fa-arrow-left me-2"></i>
              <span class="d-none d-sm-inline">Volver</span>
            </button>
          </div>
        </div>

        <!-- Badges informativos en modo vista -->
        <div class="d-flex flex-wrap gap-2" *ngIf="!modoEdicion && !esNuevo()">
          <span class="badge badge-glass">
            <i class="fas fa-hashtag me-1"></i>
            ID: {{ paciente.id }}
          </span>
          <span class="badge badge-glass">
            <i class="fas fa-id-card me-1"></i>
            DNI: {{ paciente.dni }}
          </span>
          <span class="badge badge-glass" *ngIf="paciente.obraSocial">
            <i class="fas fa-hospital me-1"></i>
            {{ paciente.obraSocial.nombre }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-body p-5">
      <!-- MODO VISTA -->
      <div *ngIf="!modoEdicion && !esNuevo()" class="row g-4">
        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-user"></i>
            </div>
            <div>
              <label class="info-label">Nombre Completo</label>
              <div class="info-value">
                {{ paciente.nombre }} {{ paciente.apellido }}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-envelope"></i>
            </div>
            <div>
              <label class="info-label">Correo Electrónico</label>
              <div class="info-value">{{ paciente.email }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-phone"></i>
            </div>
            <div>
              <label class="info-label">Teléfono</label>
              <div class="info-value">{{ paciente.telefono }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-id-card"></i>
            </div>
            <div>
              <label class="info-label">Documento</label>
              <div class="info-value">{{ paciente.dni }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div>
              <label class="info-label">Fecha de Nacimiento</label>
              <div class="info-value">
                {{ paciente.fechaNacimiento | date : "dd/MM/yyyy" }}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-hospital"></i>
            </div>
            <div>
              <label class="info-label">Obra Social</label>
              <div class="info-value">
                {{ paciente.obraSocial?.nombre || "Sin obra social" }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MODO EDICIÓN/CREACIÓN -->
      <form
        *ngIf="modoEdicion || esNuevo()"
        #form="ngForm"
        (ngSubmit)="save()"
        class="needs-validation"
        novalidate
      >
        <div class="row g-4">
          <!-- Nombre -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.nombre"
                name="nombre"
                id="nombre"
                class="form-control form-control-modern"
                placeholder="Nombre"
                required
                #nombre="ngModel"
              />
              <label for="nombre">
                <i class="fas fa-user me-2"></i>Nombre
              </label>
            </div>
            <div
              *ngIf="isInvalidField(nombre)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>
              El nombre es requerido
            </div>
          </div>

          <!-- Apellido -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.apellido"
                name="apellido"
                id="apellido"
                class="form-control form-control-modern"
                placeholder="Apellido"
                required
                #apellido="ngModel"
              />
              <label for="apellido">
                <i class="fas fa-user-tag me-2"></i>Apellido
              </label>
            </div>
            <div
              *ngIf="isInvalidField(apellido)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>
              El apellido es requerido
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.email"
                name="email"
                id="email"
                type="email"
                class="form-control form-control-modern"
                placeholder="Email"
                required
                [disabled]="esPacienteVendoSuPerfil()"
                #email="ngModel"
              />
              <label for="email">
                <i class="fas fa-envelope me-2"></i>Correo Electrónico
              </label>
            </div>
            <div *ngIf="isInvalidField(email)" class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-1"></i>
              <div *ngIf="email.errors?.['required']">
                El email es requerido
              </div>
              <div *ngIf="email.errors?.['email']">
                Debe ser un email válido
              </div>
            </div>
          </div>

          <!-- Teléfono -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.telefono"
                name="telefono"
                id="telefono"
                class="form-control form-control-modern"
                placeholder="Teléfono"
                required
                #telefono="ngModel"
              />
              <label for="telefono">
                <i class="fas fa-phone me-2"></i>Teléfono
              </label>
            </div>
            <div
              *ngIf="isInvalidField(telefono)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>
              El teléfono es requerido
            </div>
          </div>

          <!-- DNI -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.dni"
                name="dni"
                id="dni"
                type="text"
                class="form-control form-control-modern"
                placeholder="DNI"
                required
                [disabled]="esPacienteVendoSuPerfil()"
                #dni="ngModel"
              />
              <label for="dni">
                <i class="fas fa-id-card me-2"></i>Documento (DNI)
              </label>
            </div>
            <div *ngIf="isInvalidField(dni)" class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-1"></i>
              El DNI es requerido
            </div>
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="paciente.fechaNacimiento"
                name="fechaNacimiento"
                id="fechaNacimiento"
                type="date"
                class="form-control form-control-modern"
                placeholder="Fecha de Nacimiento"
                required
                [disabled]="esPacienteVendoSuPerfil()"
                #fechaNacimiento="ngModel"
              />
              <label for="fechaNacimiento">
                <i class="fas fa-calendar-alt me-2"></i>Fecha de Nacimiento
              </label>
            </div>
            <div
              *ngIf="isInvalidField(fechaNacimiento)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>
              La fecha de nacimiento es requerida
            </div>
          </div>

          <!-- Obra Social -->
          <div class="col-12">
            <div class="form-floating">
              <select
                [(ngModel)]="paciente.obraSocial"
                name="obraSocial"
                id="obraSocial"
                class="form-select form-control-modern"
                #obraSocial="ngModel"
              >
                <option [ngValue]="null" selected>Sin obra social</option>
                <option
                  *ngFor="let obraSocial of obrasSociales"
                  [ngValue]="obraSocial"
                >
                  {{ obraSocial.nombre }}
                </option>
              </select>
              <label for="obraSocial">
                <i class="fas fa-hospital me-2"></i>Obra Social (Opcional)
              </label>
            </div>
          </div>
        </div>

        <!-- Información sobre contraseña automática para nuevos pacientes -->
        <div class="col-md-12 mt-2" *ngIf="esNuevo()">
          <div
            class="alert alert-info d-flex align-items-center password-alert"
          >
            <i class="fas fa-info-circle me-3"></i>
            <div>
              <strong>Contraseña automática:</strong>
              Se generará una contraseña segura automáticamente y será enviada
              por correo electrónico al paciente.
            </div>
          </div>
        </div>

        <!-- Cambio de contraseña solo en edición de perfil propio -->
        <div
          class="col-md-12 mt-4"
          *ngIf="modoEdicion && !esNuevo() && puedeCambiarContrasena()"
        >
          <div class="section-card p-4 mb-4">
            <div class="section-header mb-3">
              <i class="fas fa-lock me-2"></i>
              <span class="fw-bold">Cambiar Contraseña</span>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="currentPassword" class="form-label"
                  >Contraseña Actual</label
                >
                <input
                  type="password"
                  id="currentPassword"
                  [(ngModel)]="changePasswordForm.currentPassword"
                  name="currentPassword"
                  class="form-control"
                  placeholder="Ingrese su contraseña actual"
                />
              </div>
              <div class="col-md-4">
                <label for="newPassword" class="form-label"
                  >Nueva Contraseña</label
                >
                <input
                  type="password"
                  id="newPassword"
                  [(ngModel)]="changePasswordForm.newPassword"
                  name="newPassword"
                  class="form-control"
                  placeholder="Ingrese la nueva contraseña"
                />
              </div>
              <div class="col-md-4">
                <label for="confirmPassword" class="form-label"
                  >Confirmar Nueva Contraseña</label
                >
                <input
                  type="password"
                  id="confirmPassword"
                  [(ngModel)]="changePasswordForm.confirmPassword"
                  name="confirmPassword"
                  class="form-control"
                  placeholder="Confirme la nueva contraseña"
                />
              </div>
            </div>
            <div class="mt-3">
              <button
                type="button"
                class="btn btn-primary-gradient px-4"
                (click)="changePassword()"
              >
                <i class="fas fa-save me-2"></i>Cambiar Contraseña
              </button>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex flex-wrap gap-3 mt-5 pt-4 border-top">
          <button
            type="submit"
            class="btn btn-success-gradient btn-lg rounded-pill px-4"
            [disabled]="form.invalid"
          >
            <i class="fas fa-save me-2"></i>
            Guardar Paciente
          </button>

          <button
            type="button"
            class="btn btn-secondary-gradient btn-lg rounded-pill px-4"
            (click)="cancelar()"
          >
            <i class="fas fa-times me-2"></i>
            Cancelar
          </button>

          <button
            *ngIf="paciente.id && !esNuevo() && !esPacienteVendoSuPerfil()"
            type="button"
            class="btn btn-danger-gradient btn-lg rounded-pill px-4"
            (click)="confirmDelete()"
          >
            <i class="fas fa-trash me-2"></i>
            Eliminar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
