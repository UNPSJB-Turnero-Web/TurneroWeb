<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card">
        <!-- HEADER DEL CARD -->
        <div class="card-header text-white">
          <div class="d-flex align-items-center">
            <div class="info-icon me-3" style="background: rgba(255,255,255,0.2);">
              üìÖ
            </div>
            <div>
              <h4 class="mb-0 fw-bold">
                <ng-container *ngIf="turno.id && turno.id !== 0; else nuevoTitle">
                  Turno #{{ turno.id }}
                </ng-container>
                <ng-template #nuevoTitle>
                  <ng-container *ngIf="esSobreturno">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Crear Sobreturno
                  </ng-container>
                  <ng-container *ngIf="!esSobreturno">
                    Nuevo Turno
                  </ng-container>
                </ng-template>
              </h4>
              <small class="opacity-75">
                <ng-container *ngIf="!modoEdicion">Informaci√≥n del Turno</ng-container>
                <ng-container *ngIf="modoEdicion && turno.id">Editando Turno</ng-container>
                <ng-container *ngIf="modoEdicion && !turno.id && esSobreturno">Registro Manual - Fuera de
                  Agenda</ng-container>
                <ng-container *ngIf="modoEdicion && !turno.id && !esSobreturno">Creando Nuevo Turno</ng-container>
              </small>
            </div>
          </div>
        </div>

        <!-- CUERPO DEL CARD -->
        <div class="card-body">
          <!-- BANNER DE ADVERTENCIA - SOBRETURNO -->
          <div *ngIf="esSobreturno" class="alert alert-warning border-warning shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-start">
              <div class="me-3" style="font-size: 2rem;">‚ö†Ô∏è</div>
              <div>
                <h5 class="alert-heading mb-2">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Modo: Creaci√≥n de Sobreturno
                </h5>
                <p class="mb-2">
                  Est√° creando un <strong>sobreturno manual</strong> que <strong>no est√° vinculado a la agenda</strong>
                  ni a los esquemas de turno predefinidos.
                </p>
                <ul class="mb-2">
                  <li>Este turno se registrar√° <strong>fuera de los slots generados autom√°ticamente</strong></li>
                  <li>Puede generar <strong>conflictos de horarios</strong> si ya existe otro turno programado</li>
                  <li>Se recomienda verificar disponibilidad del m√©dico y consultorio</li>
                </ul>
                <div class="alert alert-info mb-0 mt-3">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Tip:</strong> Use esta opci√≥n para casos excepcionales, urgencias o turnos fuera de horario
                  habitual.
                </div>
              </div>
            </div>
          </div>

          <!-- MODO VISTA -->
          <div *ngIf="!modoEdicion">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);">
                    üÜî
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">ID del Turno</div>
                    <div class="info-value">
                      <span class="turno-id-display">{{ turno.id }}</span>
                    </div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);">
                    üë§
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Paciente</div>
                    <div class="info-value">
                      <span class="paciente-display">{{ turno.nombrePaciente }} {{ turno.apellidoPaciente }}</span>
                    </div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
                    üë®‚Äç‚öïÔ∏è
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">M√©dico</div>
                    <div class="info-value">
                      <span class="medico-display">{{ turno.staffMedicoNombre }} {{ turno.staffMedicoApellido }}</span>
                    </div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #e8630a 100%);">
                    ü©∫
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Especialidad</div>
                    <div class="info-value">{{ turno.especialidadStaffMedico }}</div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #e8630a 100%);">
                    üìÖ
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Fecha</div>
                    <div class="info-value">
                      <span class="fecha-display">{{ turno.fecha }}</span>
                    </div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    üïê
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Horario</div>
                    <div class="info-value">
                      <span class="hora-display">{{ turno.horaInicio }} - {{ turno.horaFin }}</span>
                    </div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    üè•
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Centro</div>
                    <div class="info-value">{{ turno.nombreCentro }}</div>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    üö™
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Consultorio</div>
                    <div class="info-value">{{ turno.consultorioNombre }}</div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);">
                    üìä
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Estado</div>
                    <div class="info-value">
                      <span [ngClass]="getEstadoBadgeClass(turno.estado)">
                        {{ turno.estado }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12" *ngIf="turno.observaciones">
                <div class="info-item d-flex align-items-center">
                  <div class="info-icon" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                    üí¨
                  </div>
                  <div class="flex-grow-1">
                    <div class="info-label">Observaciones</div>
                    <div class="info-value">{{ turno.observaciones }}</div>
                  </div>
                </div>
              </div>

              <!-- INFORMACI√ìN DE AUDITOR√çA -->
              <div class="col-12" *ngIf="turno.id && (turno.totalModificaciones || turno.fechaUltimaModificacion)">
                <div class="audit-section mt-4">
                  <h5 class="audit-title">
                    <i class="fas fa-history"></i> Informaci√≥n de Auditor√≠a
                  </h5>
                  <div class="row">
                    <div class="col-md-6" *ngIf="turno.totalModificaciones">
                      <div class="info-item d-flex align-items-center">
                        <div class="info-icon" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                          üî¢
                        </div>
                        <div class="flex-grow-1">
                          <div class="info-label">Total Modificaciones</div>
                          <div class="info-value">
                            <span class="badge bg-primary">{{ turno.totalModificaciones }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6" *ngIf="turno.fechaUltimaModificacion">
                      <div class="info-item d-flex align-items-center">
                        <div class="info-icon" style="background: linear-gradient(135deg, #dc3545 0%, #6f42c1 100%);">
                          ‚è∞
                        </div>
                        <div class="flex-grow-1">
                          <div class="info-label">√öltima Modificaci√≥n</div>
                          <div class="info-value">
                            <small>{{ formatDateTime(turno.fechaUltimaModificacion) }}</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-12" *ngIf="turno.ultimoUsuarioModificacion">
                      <div class="info-item d-flex align-items-center">
                        <div class="info-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                          üë®‚Äçüíº
                        </div>
                        <div class="flex-grow-1">
                          <div class="info-label">Modificado por</div>
                          <div class="info-value">{{ turno.ultimoUsuarioModificacion }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-12" *ngIf="turno.motivoUltimaModificacion">
                      <div class="info-item d-flex align-items-center">
                        <div class="info-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);">
                          üí≠
                        </div>
                        <div class="flex-grow-1">
                          <div class="info-label">Motivo</div>
                          <div class="info-value">{{ turno.motivoUltimaModificacion }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- MODO EDICI√ìN -->
          <form *ngIf="modoEdicion" (ngSubmit)="save()" #turnoForm="ngForm">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);">üë§</span>
                    Paciente
                  </label>
                  <select [(ngModel)]="turno.pacienteId" name="pacienteId" class="form-control form-control-modern"
                    required>
                    <option value="">Seleccione un paciente...</option>
                    <option *ngFor="let paciente of pacientes" [value]="paciente.id">
                      {{ paciente.nombre }} {{ paciente.apellido }}
                    </option>
                  </select>
                  <div class="form-help">
                    Seleccione el paciente para el turno.
                  </div>
                </div>

                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">üë®‚Äç‚öïÔ∏è</span>
                    Staff M√©dico
                  </label>
                  <select [(ngModel)]="turno.staffMedicoId" name="staffMedicoId"
                    class="form-control form-control-modern" required>
                    <option value="">Seleccione un staff m√©dico...</option>
                    <option *ngFor="let staff of staffMedicos" [value]="staff.id">
                      {{ staff.medico?.nombre }} {{ staff.medico?.apellido }} - {{ staff.especialidad?.nombre }}
                    </option>
                  </select>
                  <div class="form-help">
                    Seleccione el m√©dico que atender√° el turno.
                  </div>
                </div>

                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">üö™</span>
                    Consultorio
                  </label>
                  <select [(ngModel)]="turno.consultorioId" name="consultorioId"
                    class="form-control form-control-modern" required>
                    <option value="">Seleccione un consultorio...</option>
                    <option *ngFor="let consultorio of consultorios" [value]="consultorio.id">
                      {{ consultorio.nombre }} - {{ consultorio.centroAtencion?.nombre }}
                    </option>
                  </select>
                  <div class="form-help">
                    Seleccione el consultorio donde se realizar√° el turno.
                  </div>
                </div>

                <!-- Estado: Fijo en CONFIRMADO para sobreturnos -->
                <div class="form-group-modern" *ngIf="esSobreturno">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">‚úÖ</span>
                    Estado
                  </label>
                  <div class="alert alert-success d-flex align-items-center mb-0">
                    <i class="fas fa-check-circle me-2" style="font-size: 1.5rem;"></i>
                    <div>
                      <strong>CONFIRMADO</strong>
                      <br>
                    </div>
                  </div>
                </div>

                <!-- Estado: Select normal para turnos regulares -->
                <div class="form-group-modern" *ngIf="!esSobreturno">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);">üìä</span>
                    Estado
                  </label>
                  <select [(ngModel)]="turno.estado" name="estado" class="form-control form-control-modern" required>
                    <option value="PROGRAMADO">PROGRAMADO</option>
                    <option value="CONFIRMADO">Confirmado</option>
                    <option value="CANCELADO">Cancelado</option>
                    <option value="COMPLETADO">Completado</option>
                  </select>
                  <div class="form-help">
                    Estado actual del turno.
                  </div>
                </div>
              </div>

              <div class="form-group-modern" *ngIf="esSobreturno">
                <label class="form-label-modern">
                  <span class="form-icon"
                    style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">üí¨</span>
                  Observaciones
                </label>
                <textarea [(ngModel)]="turno.observaciones" name="observaciones" rows="3"
                  class="form-control form-control-modern"
                  placeholder="Ingrese observaciones o detalles del sobreturno..."></textarea>
                <div class="form-help">
                  A√±ada informaci√≥n adicional relevante para este sobreturno.
                </div>
              </div>


              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #fd7e14 0%, #e8630a 100%);">üìÖ</span>
                    Fecha
                  </label>
                  <input [(ngModel)]="turno.fecha" name="fecha" type="date" class="form-control form-control-modern"
                    required />
                  <div class="form-help">
                    Fecha del turno m√©dico.
                  </div>
                </div>

                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">üïê</span>
                    Hora de Inicio
                  </label>
                  <input [(ngModel)]="turno.horaInicio" name="horaInicio" type="time"
                    class="form-control form-control-modern" required />
                  <div class="form-help">
                    Hora de inicio del turno.
                  </div>
                </div>

                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <span class="form-icon"
                      style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">üïê</span>
                    Hora de Fin
                  </label>
                  <input [(ngModel)]="turno.horaFin" name="horaFin" type="time" class="form-control form-control-modern"
                    required />
                  <div class="form-help">
                    Hora de finalizaci√≥n del turno.
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- FOOTER DEL CARD -->
        <div class="card-footer">
          <div class="d-flex gap-2 flex-wrap">
            <!-- Botones en modo vista -->
            <ng-container *ngIf="!modoEdicion">
              <button type="button" class="btn btn-modern btn-back" (click)="goBack()">
                ‚Üê Volver
              </button>
              <button type="button" class="btn btn-modern btn-edit" (click)="activarEdicion()">
                ‚úèÔ∏è Editar
              </button>
              <button type="button" class="btn btn-modern btn-info" (click)="toggleAuditPanel()"
                *ngIf="turno.id && turno.totalModificaciones && turno.totalModificaciones > 0">
                üìä Auditor√≠a ({{ turno.totalModificaciones }})
              </button>
              <button type="button" class="btn btn-modern btn-success" (click)="verifyAuditIntegrity()"
                *ngIf="turno.id && turno.totalModificaciones && turno.totalModificaciones > 0">
                üõ°Ô∏è Verificar
              </button>
              <button type="button" class="btn btn-modern btn-delete ms-auto" (click)="remove(turno)" *ngIf="turno.id">
                üóëÔ∏è Eliminar
              </button>
            </ng-container>

            <!-- Botones en modo edici√≥n -->
            <ng-container *ngIf="modoEdicion">
              <button type="submit" class="btn btn-modern btn-save" [class.btn-warning]="esSobreturno"
                [disabled]="allFieldsEmpty()" (click)="save()">
                <ng-container *ngIf="esSobreturno">
                  <i class="fas fa-exclamation-triangle me-2"></i>Crear Sobreturno
                </ng-container>
                <ng-container *ngIf="!esSobreturno">
                  üíæ Guardar
                </ng-container>
              </button>
              <button type="button" class="btn btn-modern btn-cancel" (click)="cancelar()">
                ‚ùå Cancelar
              </button>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- PANEL DE AUDITOR√çA -->
      <div class="card mt-4" *ngIf="showAuditPanel && turno.id">
        <div class="card-header bg-info text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="info-icon me-3" style="background: rgba(255,255,255,0.2);">
                üìä
              </div>
              <div>
                <h5 class="mb-0">Historial de Auditor√≠a</h5>
                <small class="opacity-75">Turno #{{ turno.id }}</small>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-light" (click)="toggleAuditPanel()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div *ngIf="loadingAudit" class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2 text-muted">Cargando historial de auditor√≠a...</p>
          </div>

          <div *ngIf="!loadingAudit && auditHistory.length === 0" class="text-center py-4">
            <i class="fas fa-history fa-3x text-muted mb-3"></i>
            <p class="text-muted">No se encontraron registros de auditor√≠a para este turno</p>
          </div>

          <div *ngIf="!loadingAudit && auditHistory.length > 0">
            <div class="audit-timeline">
              <div class="audit-entry" *ngFor="let log of auditHistory; let i = index">
                <div class="audit-entry-content">
                  <div class="audit-header">
                    <span [class]="getActionClass(log.action)">
                      <i [class]="getActionIcon(log.action)"></i>
                      {{ log.action }}
                    </span>
                    <small class="text-muted">{{ formatDateTime(log.performedAt) }}</small>
                  </div>

                  <div class="audit-details">
                    <div class="row">
                      <div class="col-md-6" *ngIf="log.performedBy">
                        <strong>Usuario:</strong> {{ log.performedBy }}
                      </div>
                      <div class="col-md-6" *ngIf="log.estadoAnterior || log.estadoNuevo">
                        <strong>Estado:</strong>
                        <span class="badge bg-secondary me-1" *ngIf="log.estadoAnterior">{{ log.estadoAnterior }}</span>
                        <i class="fas fa-arrow-right" *ngIf="log.estadoAnterior && log.estadoNuevo"></i>
                        <span class="badge bg-primary ms-1" *ngIf="log.estadoNuevo">{{ log.estadoNuevo }}</span>
                      </div>
                    </div>
                    <div class="row mt-2" *ngIf="log.reason">
                      <div class="col-12">
                        <strong>Motivo:</strong> {{ log.reason }}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="audit-line" *ngIf="i < auditHistory.length - 1"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>