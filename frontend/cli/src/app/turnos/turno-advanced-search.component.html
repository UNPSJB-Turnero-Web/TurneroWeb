<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Búsqueda Avanzada de Turnos</h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" (click)="showAdvancedFilters = !showAdvancedFilters">
              <i class="fas fa-filter"></i> Filtros Avanzados
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filtros básicos siempre visibles -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="estado" class="form-label">Estado</label>
              <select id="estado" class="form-select" [(ngModel)]="filter.estado" (change)="search()">
                <option *ngFor="let estado of estadosDisponibles" [value]="estado.value">{{estado.label}}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="fechaDesde" class="form-label">Fecha Desde</label>
              <input type="date" id="fechaDesde" class="form-control" [(ngModel)]="filter.fechaDesde" (change)="search()">
            </div>
            <div class="col-md-3">
              <label for="fechaHasta" class="form-label">Fecha Hasta</label>
              <input type="date" id="fechaHasta" class="form-control" [(ngModel)]="filter.fechaHasta" (change)="search()">
            </div>
            <div class="col-md-3">
              <label for="nombrePaciente" class="form-label">Nombre Paciente</label>
              <input type="text" id="nombrePaciente" class="form-control" [(ngModel)]="filter.nombrePaciente" 
                     placeholder="Buscar por nombre..." (keyup.enter)="search()">
            </div>
          </div>

          <!-- Filtros avanzados (colapsable) -->
          <div class="row mb-3" *ngIf="showAdvancedFilters">
            <div class="col-md-3">
              <label for="nombreMedico" class="form-label">Nombre Médico</label>
              <input type="text" id="nombreMedico" class="form-control" [(ngModel)]="filter.nombreMedico" 
                     placeholder="Buscar por médico..." (keyup.enter)="search()">
            </div>
            <div class="col-md-3">
              <label for="nombreEspecialidad" class="form-label">Especialidad</label>
              <input type="text" id="nombreEspecialidad" class="form-control" [(ngModel)]="filter.nombreEspecialidad" 
                     placeholder="Buscar por especialidad..." (keyup.enter)="search()">
            </div>
            <div class="col-md-3">
              <label for="nombreCentro" class="form-label">Centro de Atención</label>
              <input type="text" id="nombreCentro" class="form-control" [(ngModel)]="filter.nombreCentro" 
                     placeholder="Buscar por centro..." (keyup.enter)="search()">
            </div>
            <div class="col-md-3">
              <label for="usuarioModificacion" class="form-label">Usuario Modificación</label>
              <input type="text" id="usuarioModificacion" class="form-control" [(ngModel)]="filter.usuarioModificacion" 
                     placeholder="Usuario que modificó..." (keyup.enter)="search()">
            </div>
          </div>

          <!-- Controles de acción -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="btn-group me-2">
                <button type="button" class="btn btn-primary" (click)="search()" [disabled]="loading">
                  <i class="fas fa-search" *ngIf="!loading"></i>
                  <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
                  Buscar
                </button>
                <button type="button" class="btn btn-secondary" (click)="resetFilters()">
                  <i class="fas fa-undo"></i> Limpiar
                </button>
              </div>
              
              <div class="btn-group">
                <button type="button" class="btn btn-success" (click)="exportCSV()" [disabled]="exportLoading">
                  <i class="fas fa-file-csv"></i> Exportar CSV
                </button>
                <button type="button" class="btn btn-danger" (click)="exportPDF()" [disabled]="exportLoading">
                  <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
              </div>
            </div>
          </div>

          <!-- Información de resultados -->
          <div class="row mb-3" *ngIf="!loading">
            <div class="col-12">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Se encontraron <strong>{{totalElements}}</strong> turnos. 
                Página {{currentPage + 1}} de {{totalPages}}.
              </div>
            </div>
          </div>

          <!-- Tabla de resultados -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th (click)="changeSort('id')" style="cursor: pointer;">
                    ID
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'id'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'id' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'id' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th (click)="changeSort('fecha')" style="cursor: pointer;">
                    Fecha
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'fecha'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'fecha' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'fecha' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th>Hora</th>
                  <th (click)="changeSort('estado')" style="cursor: pointer;">
                    Estado
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'estado'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'estado' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'estado' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th>Paciente</th>
                  <th>Médico</th>
                  <th>Especialidad</th>
                  <th>Centro</th>
                  <th>Modificaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let turno of turnos" [class.table-warning]="turno.totalModificaciones && turno.totalModificaciones > 0">
                  <td>{{turno.id}}</td>
                  <td>{{formatDate(turno.fecha)}}</td>
                  <td>{{turno.horaInicio}} - {{turno.horaFin}}</td>
                  <td>
                    <span [class]="getEstadoClass(turno.estado)">{{turno.estado}}</span>
                  </td>
                  <td>{{turno.nombrePaciente}} {{turno.apellidoPaciente}}</td>
                  <td>{{turno.staffMedicoNombre}} {{turno.staffMedicoApellido}}</td>
                  <td>{{turno.especialidadStaffMedico}}</td>
                  <td>{{turno.nombreCentro}}</td>
                  <td>
                    <span class="badge bg-info" *ngIf="turno.totalModificaciones && turno.totalModificaciones > 0">
                      {{turno.totalModificaciones}} modificaciones
                    </span>
                    <span class="badge bg-success" *ngIf="!turno.totalModificaciones || turno.totalModificaciones === 0">
                      Sin modificaciones
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary" (click)="goToDetail(turno)" title="Ver detalle">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button type="button" class="btn btn-outline-info" (click)="showAuditHistory(turno)" title="Ver auditoría">
                        <i class="fas fa-history"></i>
                      </button>
                      <button type="button" class="btn btn-outline-warning" (click)="editTurno(turno)" title="Editar">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="btn btn-outline-success" 
                              (click)="verifyIntegrity(turno.id!)" 
                              title="Verificar integridad"
                              *ngIf="turno.totalModificaciones && turno.totalModificaciones > 0">
                        <i class="fas fa-shield-alt"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="turnos.length === 0 && !loading">
                  <td colspan="10" class="text-center text-muted">
                    <i class="fas fa-search"></i> No se encontraron turnos con los criterios especificados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <nav aria-label="Paginación de turnos" *ngIf="totalPages > 1">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="changePage(0)" [disabled]="currentPage === 0">
                  <i class="fas fa-angle-double-left"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 0">
                  <i class="fas fa-angle-left"></i>
                </button>
              </li>
              
              <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
                  [class.active]="currentPage === i">
                <button class="page-link" (click)="changePage(i)">{{i + 1}}</button>
              </li>
              
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="changePage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1">
                  <i class="fas fa-angle-right"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="changePage(totalPages - 1)" [disabled]="currentPage >= totalPages - 1">
                  <i class="fas fa-angle-double-right"></i>
                </button>
              </li>
            </ul>
          </nav>

          <!-- Selector de tamaño de página -->
          <div class="row">
            <div class="col-12 text-center">
              <div class="btn-group btn-group-sm">
                <span class="btn btn-outline-secondary disabled">Elementos por página:</span>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 10" (click)="changePageSize(10)">10</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 20" (click)="changePageSize(20)">20</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 50" (click)="changePageSize(50)">50</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 100" (click)="changePageSize(100)">100</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Auditoría -->
<div class="modal fade" [class.show]="showAuditPanel" [style.display]="showAuditPanel ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showAuditPanel">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-history"></i> Historial de Auditoría - Turno #{{selectedTurno?.id}}
        </h5>
        <button type="button" class="btn-close" (click)="closeAuditPanel()"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3" *ngIf="selectedTurno">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Información del Turno</h6>
                <p class="card-text">
                  <strong>Paciente:</strong> {{selectedTurno.nombrePaciente}} {{selectedTurno.apellidoPaciente}}<br>
                  <strong>Médico:</strong> {{selectedTurno.staffMedicoNombre}} {{selectedTurno.staffMedicoApellido}}<br>
                  <strong>Fecha:</strong> {{formatDate(selectedTurno.fecha)}} - {{selectedTurno.horaInicio}} a {{selectedTurno.horaFin}}<br>
                  <strong>Estado Actual:</strong> <span [class]="getEstadoClass(selectedTurno.estado)">{{selectedTurno.estado}}</span><br>
                  <strong>Total Modificaciones:</strong> {{selectedTurno.totalModificaciones || 0}}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-dark">
              <tr>
                <th>Fecha/Hora</th>
                <th>Acción</th>
                <th>Usuario</th>
                <th>Estado Anterior</th>
                <th>Estado Nuevo</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of auditHistory">
                <td>{{formatDateTime(log.performedAt)}}</td>
                <td>
                  <span [class]="getActionClass(log.action)">{{log.action}}</span>
                </td>
                <td>
                  <i class="fas fa-user"></i> {{log.performedBy}}
                </td>
                <td>
                  <span class="badge bg-secondary" *ngIf="log.previousStatus">{{log.previousStatus}}</span>
                  <span class="text-muted" *ngIf="!log.previousStatus">-</span>
                </td>
                <td>
                  <span class="badge bg-primary" *ngIf="log.newStatus">{{log.newStatus}}</span>
                  <span class="text-muted" *ngIf="!log.newStatus">-</span>
                </td>
                <td>
                  <small>{{log.reason || 'Sin motivo especificado'}}</small>
                </td>
              </tr>
              <tr *ngIf="auditHistory.length === 0">
                <td colspan="6" class="text-center text-muted">
                  <i class="fas fa-info-circle"></i> No se encontraron registros de auditoría
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" (click)="verifyIntegrity(selectedTurno!.id!)"
                *ngIf="selectedTurno?.id">
          <i class="fas fa-shield-alt"></i> Verificar Integridad
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeAuditPanel()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade show" *ngIf="showAuditPanel" (click)="closeAuditPanel()"></div>
