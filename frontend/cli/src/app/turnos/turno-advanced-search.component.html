<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i [class]="getCurrentTipoVistaIcon()"></i> 
            {{getCurrentTipoVistaLabel()}}
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" (click)="showAdvancedFilters = !showAdvancedFilters">
              <i class="fas fa-filter"></i> Filtros Avanzados
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Selector de tipo de vista/reporte -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="tipoVista" class="form-label">
                <i class="fas fa-eye"></i> Tipo de Vista/Reporte
              </label>
              <select id="tipoVista" class="form-select" [(ngModel)]="tipoVista" (change)="onTipoVistaChange()">
                <option *ngFor="let tipo of tiposVista" [value]="tipo.value">
                  {{tipo.label}}
                </option>
              </select>
            </div>
            <div class="col-md-8" *ngIf="tipoVista !== 'busqueda'">
              <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle"></i>
                <strong>Modo Reporte:</strong> Los filtros de fecha son obligatorios para generar reportes.
              </div>
            </div>
          </div>

          <!-- Filtros básicos siempre visibles -->
          <div class="row mb-3">
            <!-- Estado - Solo para búsqueda normal -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda'">
              <label for="estado" class="form-label">Estado</label>
              <select id="estado" class="form-select" [(ngModel)]="filter.estado" (change)="search()">
                <option *ngFor="let estado of estadosDisponibles" [value]="estado.value">{{estado.label}}</option>
              </select>
            </div>
            
            <!-- Fechas - Siempre visibles pero obligatorias para reportes -->
            <div [class]="tipoVista === 'busqueda' ? 'col-md-3' : 'col-md-4'">
              <label for="fechaDesde" class="form-label">
                Fecha Desde 
                <span class="text-danger" *ngIf="tipoVista !== 'busqueda'">*</span>
              </label>
              <input type="date" id="fechaDesde" class="form-control" [(ngModel)]="filter.fechaDesde" (change)="onFilterChange()">
            </div>
            <div [class]="tipoVista === 'busqueda' ? 'col-md-3' : 'col-md-4'">
              <label for="fechaHasta" class="form-label">
                Fecha Hasta 
                <span class="text-danger" *ngIf="tipoVista !== 'busqueda'">*</span>
              </label>
              <input type="date" id="fechaHasta" class="form-control" [(ngModel)]="filter.fechaHasta" (change)="onFilterChange()">
            </div>
            
            <!-- Nombre Paciente - Solo para búsqueda normal -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda'">
              <label for="nombrePaciente" class="form-label">Nombre Paciente</label>
              <input type="text" id="nombrePaciente" class="form-control" [(ngModel)]="filter.nombrePaciente" 
                     placeholder="Buscar por nombre..." (keyup.enter)="search()">
            </div>
            
            <!-- Consultorio - Para reportes que lo requieren -->
            <div class="col-md-4" *ngIf="tipoVista === 'reporte-dia-consultorio' || tipoVista === 'reporte-cancelaciones'">
              <label for="nombreConsultorio" class="form-label">Consultorio</label>
              <input type="text" id="nombreConsultorio" class="form-control" [(ngModel)]="filter.nombreConsultorio" 
                     placeholder="Filtrar por consultorio..." (change)="onFilterChange()">
            </div>
          </div>

          <!-- Filtros avanzados (colapsable) -->
          <div class="row mb-3" *ngIf="showAdvancedFilters">
            <!-- Médico - Visible según el tipo de vista -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda' || tipoVista === 'reporte-especialidad-medico'">
              <label for="nombreMedico" class="form-label">Nombre Médico</label>
              <input type="text" id="nombreMedico" class="form-control" [(ngModel)]="filter.nombreMedico" 
                     placeholder="Buscar por médico..." (keyup.enter)="tipoVista === 'busqueda' ? search() : onFilterChange()">
            </div>
            
            <!-- Especialidad - Visible según el tipo de vista -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda' || tipoVista === 'reporte-especialidad-medico' || tipoVista === 'reporte-cancelaciones'">
              <label for="nombreEspecialidad" class="form-label">Especialidad</label>
              <input type="text" id="nombreEspecialidad" class="form-control" [(ngModel)]="filter.nombreEspecialidad" 
                     placeholder="Buscar por especialidad..." (keyup.enter)="tipoVista === 'busqueda' ? search() : onFilterChange()">
            </div>
            
            <!-- Centro de Atención - Solo para búsqueda normal -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda'">
              <label for="nombreCentro" class="form-label">Centro de Atención</label>
              <input type="text" id="nombreCentro" class="form-control" [(ngModel)]="filter.nombreCentro" 
                     placeholder="Buscar por centro..." (keyup.enter)="search()">
            </div>
            
            <!-- Usuario Modificación - Solo para búsqueda normal -->
            <div class="col-md-3" *ngIf="tipoVista === 'busqueda'">
              <label for="usuarioModificacion" class="form-label">Usuario Modificación</label>
              <input type="text" id="usuarioModificacion" class="form-control" [(ngModel)]="filter.usuarioModificacion" 
                     placeholder="Usuario que modificó..." (keyup.enter)="search()">
            </div>
          </div>

          <!-- Controles de acción -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="btn-group me-2">
                <!-- Botón dinámico según el tipo de vista -->
                <button type="button" class="btn btn-primary" (click)="executeSearch()" [disabled]="loading">
                  <i class="fas fa-search" *ngIf="!loading && tipoVista === 'busqueda'"></i>
                  <i class="fas fa-chart-line" *ngIf="!loading && tipoVista !== 'busqueda'"></i>
                  <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
                  {{tipoVista === 'busqueda' ? 'Buscar' : 'Generar Reporte'}}
                </button>
                <button type="button" class="btn btn-secondary" (click)="resetFilters()">
                  <i class="fas fa-undo"></i> Limpiar
                </button>
              </div>
              
              <!-- Botones de exportación -->
              <div class="btn-group" *ngIf="(tipoVista === 'busqueda' && turnos.length > 0) || (tipoVista !== 'busqueda' && hasReportData())">
                <button type="button" class="btn btn-success" (click)="exportCSV()" [disabled]="exportLoading">
                  <i class="fas fa-file-csv"></i> Exportar CSV
                </button>
                <button type="button" class="btn btn-danger" (click)="exportPDF()" [disabled]="exportLoading">
                  <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
              </div>
            </div>
          </div>

          <!-- Mensaje de validación para reportes -->
          <div class="alert alert-warning" *ngIf="tipoVista !== 'busqueda' && (!filter.fechaDesde || !filter.fechaHasta)">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Atención:</strong> Debe seleccionar las fechas "Desde" y "Hasta" para generar reportes.
          </div>

          <!-- Resultados de Reportes -->
          <div class="card mb-3" *ngIf="tipoVista !== 'busqueda' && hasReportData()">
            <div class="card-header bg-info text-white">
              <h5 class="card-title mb-0">
                <i [class]="getCurrentTipoVistaIcon()"></i> 
                {{getCurrentTipoVistaLabel()}}
              </h5>
            </div>
            <div class="card-body">
              
              <!-- Reporte: Turnos por Día y Consultorio -->
              <div *ngIf="tipoVista === 'reporte-dia-consultorio'" class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead class="table-dark">
                    <tr>
                      <th>Fecha</th>
                      <th>Consultorio</th>
                      <th>Médico</th>
                      <th>Especialidad</th>
                      <th>Total Turnos</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of reportData.turnosPorDiaConsultorio">
                      <td>{{formatDate(item.fecha)}}</td>
                      <td>{{item.consultorio}}</td>
                      <td>{{item.medico}}</td>
                      <td>{{item.especialidad}}</td>
                      <td><span class="badge bg-primary">{{item.cantidad}}</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Reporte: Turnos por Especialidad y Médico -->
              <div *ngIf="tipoVista === 'reporte-especialidad-medico'" class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead class="table-dark">
                    <tr>
                      <th>Médico</th>
                      <th>Especialidad</th>
                      <th>Total Turnos</th>
                      <th>Atendidos</th>
                      <th>Cancelados</th>
                      <th>Reagendados</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of reportData.turnosPorEspecialidadMedico">
                      <td>{{item.medico}}</td>
                      <td>{{item.especialidad}}</td>
                      <td><span class="badge bg-info">{{item.totalTurnos}}</span></td>
                      <td><span class="badge bg-success">{{item.turnosAtendidos}}</span></td>
                      <td><span class="badge bg-danger">{{item.turnosCancelados}}</span></td>
                      <td><span class="badge bg-warning">{{item.turnosReagendados}}</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Reporte: Cancelaciones y Reprogramaciones -->
              <div *ngIf="tipoVista === 'reporte-cancelaciones'" class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead class="table-dark">
                    <tr>
                      <th>Fecha</th>
                      <th>Paciente</th>
                      <th>Médico</th>
                      <th>Especialidad</th>
                      <th>Estado Final</th>
                      <th>Motivo</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of reportData.cancelacionesReprogramaciones">
                      <td>{{formatDate(item.fecha)}}</td>
                      <td>{{item.paciente}}</td>
                      <td>{{item.medico}}</td>
                      <td>{{item.especialidad}}</td>
                      <td>
                        <span [class]="getEstadoClass(item.estadoFinal)">
                          {{getEstadoLabel(item.estadoFinal)}}
                        </span>
                      </td>
                      <td>{{item.motivo || 'Sin especificar'}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Mensaje si no hay datos de reporte -->
          <div class="alert alert-info" *ngIf="tipoVista !== 'busqueda' && !hasReportData() && !loading">
            <i class="fas fa-info-circle"></i> 
            {{hasExecutedSearch() ? 'No se encontraron datos para el reporte seleccionado con los filtros aplicados.' : 'Haga clic en "Generar Reporte" para visualizar los datos.'}}
          </div>

          <!-- Tabla de resultados -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th (click)="changeSort('id')" style="cursor: pointer;">
                    ID
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'id'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'id' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'id' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th (click)="changeSort('fecha')" style="cursor: pointer;">
                    Fecha
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'fecha'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'fecha' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'fecha' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th>Hora</th>
                  <th (click)="changeSort('estado')" style="cursor: pointer;">
                    Estado
                    <i class="fas fa-sort" *ngIf="filter.sortBy !== 'estado'"></i>
                    <i class="fas fa-sort-up" *ngIf="filter.sortBy === 'estado' && filter.sortDirection === 'ASC'"></i>
                    <i class="fas fa-sort-down" *ngIf="filter.sortBy === 'estado' && filter.sortDirection === 'DESC'"></i>
                  </th>
                  <th>Paciente</th>
                  <th>Médico</th>
                  <th>Especialidad</th>
                  <th>Centro</th>
                  <th>Modificaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let turno of turnos; trackBy: trackByTurnoId" [class.table-warning]="turno.totalModificaciones && turno.totalModificaciones > 0">
                  <td>{{turno.id}}</td>
                  <td>{{formatDate(turno.fecha)}}</td>
                  <td>{{turno.horaInicio}} - {{turno.horaFin}}</td>
                  <td>
                    <span [class]="getEstadoClass(turno.estado)">{{turno.estado}}</span>
                  </td>
                  <td>{{turno.nombrePaciente}} {{turno.apellidoPaciente}}</td>
                  <td>{{turno.staffMedicoNombre}} {{turno.staffMedicoApellido}}</td>
                  <td>{{turno.especialidadStaffMedico}}</td>
                  <td>{{turno.nombreCentro}}</td>
                  <td>
                    <span class="badge bg-info" *ngIf="turno.totalModificaciones && turno.totalModificaciones > 0">
                      {{turno.totalModificaciones}} modificaciones
                    </span>
                    <span class="badge bg-success" *ngIf="!turno.totalModificaciones || turno.totalModificaciones === 0">
                      Sin modificaciones
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary" (click)="goToDetail(turno)" title="Ver detalle">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button type="button" class="btn btn-outline-info" (click)="showAuditHistory(turno)" title="Ver auditoría">
                        <i class="fas fa-history"></i>
                      </button>
                      <button type="button" class="btn btn-outline-secondary" (click)="openChangeStateModal(turno)" title="Cambiar estado"
                              [disabled]="turno.estado === 'CANCELADO' || turno.estado === 'COMPLETADO' || turno.estado === 'COMPLETO' || turno.estado === 'REAGENDADO'">
                        <i class="fas fa-exchange-alt"></i>
                      </button>
                
                      <button type="button" class="btn btn-outline-success" 
                              (click)="verifyIntegrity(turno.id!)" 
                              title="Verificar integridad"
                              *ngIf="turno.totalModificaciones && turno.totalModificaciones > 0">
                        <i class="fas fa-shield-alt"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="turnos.length === 0 && !loading">
                  <td colspan="10" class="text-center text-muted">
                    <i class="fas fa-search"></i> No se encontraron turnos con los criterios especificados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <nav aria-label="Paginación de turnos" *ngIf="totalPages > 1">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="changePage(0)" [disabled]="currentPage === 0">
                  <i class="fas fa-angle-double-left"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 0">
                  <i class="fas fa-angle-left"></i>
                </button>
              </li>
              
              <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
                  [class.active]="currentPage === i">
                <button class="page-link" (click)="changePage(i)">{{i + 1}}</button>
              </li>
              
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="changePage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1">
                  <i class="fas fa-angle-right"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="changePage(totalPages - 1)" [disabled]="currentPage >= totalPages - 1">
                  <i class="fas fa-angle-double-right"></i>
                </button>
              </li>
            </ul>
          </nav>

          <!-- Selector de tamaño de página -->
          <div class="row">
            <div class="col-12 text-center">
              <div class="btn-group btn-group-sm">
                <span class="btn btn-outline-secondary disabled">Elementos por página:</span>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 10" (click)="changePageSize(10)">10</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 20" (click)="changePageSize(20)">20</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 50" (click)="changePageSize(50)">50</button>
                <button type="button" class="btn btn-outline-primary" 
                        [class.active]="filter.size === 100" (click)="changePageSize(100)">100</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Auditoría -->
<div class="modal fade" [class.show]="showAuditPanel" [style.display]="showAuditPanel ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showAuditPanel">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-history"></i> Historial de Auditoría - Turno #{{selectedTurno?.id}}
        </h5>
        <button type="button" class="btn-close" (click)="closeAuditPanel()"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3" *ngIf="selectedTurno">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Información del Turno</h6>
                <p class="card-text">
                  <strong>Paciente:</strong> {{selectedTurno.nombrePaciente}} {{selectedTurno.apellidoPaciente}}<br>
                  <strong>Médico:</strong> {{selectedTurno.staffMedicoNombre}} {{selectedTurno.staffMedicoApellido}}<br>
                  <strong>Fecha:</strong> {{formatDate(selectedTurno.fecha)}} - {{selectedTurno.horaInicio}} a {{selectedTurno.horaFin}}<br>
                  <strong>Estado Actual:</strong> <span [class]="getEstadoClass(selectedTurno.estado)">{{selectedTurno.estado}}</span><br>
                  <strong>Total Modificaciones:</strong> {{selectedTurno.totalModificaciones || 0}}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-dark">
              <tr>
                <th>Fecha/Hora</th>
                <th>Acción</th>
                <th>Usuario</th>
                <th>Estado Anterior</th>
                <th>Estado Nuevo</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of auditHistory">
                <td>{{formatDateTime(log.performedAt)}}</td>
                <td>
                  <span [class]="getActionClass(log.action)">{{log.action}}</span>
                </td>
                <td>
                  <i class="fas fa-user"></i> {{log.performedBy}}
                </td>
                <td>
                  <span class="badge bg-secondary" *ngIf="log.previousStatus">{{log.previousStatus}}</span>
                  <span class="text-muted" *ngIf="!log.previousStatus">-</span>
                </td>
                <td>
                  <span class="badge bg-primary" *ngIf="log.newStatus">{{log.newStatus}}</span>
                  <span class="text-muted" *ngIf="!log.newStatus">-</span>
                </td>
                <td>
                  <small>{{log.reason || 'Sin motivo especificado'}}</small>
                </td>
              </tr>
              <tr *ngIf="auditHistory.length === 0">
                <td colspan="6" class="text-center text-muted">
                  <i class="fas fa-info-circle"></i> No se encontraron registros de auditoría
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" (click)="verifyIntegrity(selectedTurno!.id!)"
                *ngIf="selectedTurno?.id">
          <i class="fas fa-shield-alt"></i> Verificar Integridad
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeAuditPanel()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade show" *ngIf="showAuditPanel" (click)="closeAuditPanel()"></div>

<!-- Modal de cambio de estado -->
<div class="modal fade" [class.show]="showChangeStateModal" [style.display]="showChangeStateModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showChangeStateModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exchange-alt"></i> Cambiar Estado del Turno
        </h5>
        <button type="button" class="btn-close" (click)="closeChangeStateModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedTurno">
          <div class="mb-3">
            <strong>Turno ID:</strong> {{selectedTurno.id}}<br>
            <strong>Paciente:</strong> {{selectedTurno.nombrePaciente}} {{selectedTurno.apellidoPaciente}}<br>
            <strong>Médico:</strong> {{selectedTurno.staffMedicoNombre}} {{selectedTurno.staffMedicoApellido}}<br>
            <strong>Fecha:</strong> {{formatDate(selectedTurno.fecha)}}<br>
            <strong>Estado actual:</strong> 
            <span [class]="getEstadoClass(selectedTurno.estado)">{{getEstadoLabel(selectedTurno.estado)}}</span>
          </div>

          <hr>

          <form>
            <div class="mb-3">
              <label for="nuevoEstado" class="form-label">Nuevo Estado <span class="text-danger">*</span></label>
              <select id="nuevoEstado" class="form-select" [(ngModel)]="changeStateForm.nuevoEstado" name="nuevoEstado" required>
                <option value="">Seleccione un estado...</option>
                <option *ngFor="let estado of validNextStates" [value]="estado">
                  {{getEstadoLabel(estado)}}
                </option>
              </select>
            </div>

            <div class="mb-3" *ngIf="changeStateForm.nuevoEstado === 'CANCELADO'">
              <label for="motivo" class="form-label">
                Motivo <span class="text-danger">*</span>
                <small class="text-muted">(mínimo 5 caracteres)</small>
              </label>
              <textarea id="motivo" class="form-control" [(ngModel)]="changeStateForm.motivo" name="motivo" 
                        rows="3" placeholder="Ingrese el motivo de la cancelación..." required></textarea>
            </div>

            <div class="mb-3" *ngIf="changeStateForm.nuevoEstado === 'REAGENDADO'">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Reagendamiento:</strong> A continuación podrá seleccionar el nuevo horario y especificar el motivo del reagendamiento.
              </div>
            </div>

            <div class="mb-3" *ngIf="changeStateForm.nuevoEstado && changeStateForm.nuevoEstado !== 'CANCELADO' && changeStateForm.nuevoEstado !== 'REAGENDADO'">
              <label for="motivo" class="form-label">
                Motivo <small class="text-muted">(opcional)</small>
              </label>
              <textarea id="motivo" class="form-control" [(ngModel)]="changeStateForm.motivo" name="motivo" 
                        rows="2" placeholder="Motivo del cambio (opcional)..."></textarea>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeChangeStateModal()" [disabled]="loading">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="changeState()" 
                [disabled]="!changeStateForm.nuevoEstado || loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
          <i *ngIf="!loading && changeStateForm.nuevoEstado === 'REAGENDADO'" class="fas fa-calendar-alt"></i>
          <i *ngIf="!loading && changeStateForm.nuevoEstado !== 'REAGENDADO'" class="fas fa-check"></i>
          {{changeStateForm.nuevoEstado === 'REAGENDADO' ? 'Continuar con Reagendamiento' : 'Cambiar Estado'}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade" [class.show]="showChangeStateModal" *ngIf="showChangeStateModal"></div>

<!-- Modal de Reagendamiento -->
<div class="modal fade" [class.show]="showReagendarModal" [style.display]="showReagendarModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showReagendarModal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-calendar-check"></i> Reagendar Turno
        </h5>
        <button type="button" class="btn-close" (click)="closeReagendarModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Información del turno actual -->
        <div class="current-appointment mb-4" *ngIf="selectedTurno">
          <h6><i class="fas fa-info-circle"></i> Turno Actual</h6>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Fecha actual:</strong> {{formatDate(selectedTurno.fecha)}}</p>
                  <p><strong>Hora:</strong> {{selectedTurno.horaInicio}} - {{selectedTurno.horaFin}}</p>
                  <p><strong>Paciente:</strong> {{selectedTurno.nombrePaciente}} {{selectedTurno.apellidoPaciente}}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Médico:</strong> {{selectedTurno.staffMedicoNombre}} {{selectedTurno.staffMedicoApellido}}</p>
                  <p><strong>Especialidad:</strong> {{selectedTurno.especialidadStaffMedico}}</p>
                  <p><strong>Centro:</strong> {{selectedTurno.nombreCentro}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-slots text-center" *ngIf="isLoadingSlots">
          <i class="fas fa-spinner fa-spin"></i>
          Cargando horarios disponibles...
        </div>

        <!-- No Slots Available -->
        <div class="no-slots text-center" *ngIf="!isLoadingSlots && slotsDisponibles.length === 0 && selectedTurno">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <h5>No hay horarios disponibles</h5>
          <p class="text-muted">No se encontraron horarios disponibles para este médico en las próximas 4 semanas.</p>
        </div>

        <!-- Slots Agrupados por Fecha -->
        <div class="slots-grouped" *ngIf="!isLoadingSlots && slotsDisponibles.length > 0">
          <h6><i class="fas fa-calendar-alt"></i> Horarios Disponibles del Mismo Médico</h6>
          <p class="text-muted mb-3">Selecciona un nuevo horario disponible:</p>
          
          <div *ngFor="let fecha of fechasOrdenadas" class="fecha-group mb-4">
            <!-- Header de fecha -->
            <div class="fecha-header mb-2">
              <h6 class="fecha-title">
                <i class="fas fa-calendar-day"></i>
                {{formatearFecha(fecha)}}
              </h6>
            </div>

            <!-- Slots de la fecha -->
            <div class="row">
              <div class="col-md-4 mb-2" *ngFor="let slot of slotsPorFecha[fecha]">
                <div class="slot-card" 
                     [class.selected]="slotSeleccionado?.id === slot.id"
                     (click)="seleccionarSlot(slot)">
                  <div class="slot-time">
                    <i class="fas fa-clock"></i>
                    {{slot.horaInicio}} - {{slot.horaFin}}
                  </div>
                  
                  <div class="slot-location">
                    <div class="location-line">
                      <i class="fas fa-door-open"></i>
                      {{slot.consultorioNombre}}
                    </div>
                    <div class="location-line">
                      <i class="fas fa-map-marker-alt"></i>
                      {{slot.nombreCentro}}
                    </div>
                  </div>

                  <div class="slot-status disponible">
                    <i class="fas fa-check-circle"></i>
                    Disponible
                  </div>

                  <div class="slot-check" *ngIf="slotSeleccionado?.id === slot.id">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Motivo del Reagendamiento -->
        <div class="motivo-section" *ngIf="slotSeleccionado">
          <h6><i class="fas fa-comment-alt"></i> Motivo del Reagendamiento</h6>
          <div class="mb-3">
            <label for="motivoReagendamiento" class="form-label">
              Indique el motivo por el cual reagenda el turno <span class="text-danger">*</span>
              <small class="text-muted">(mínimo 5 caracteres)</small>
            </label>
            <textarea 
              id="motivoReagendamiento" 
              class="form-control"
              [(ngModel)]="motivoReagendamiento" 
              name="motivoReagendamiento"
              rows="3" 
              placeholder="Ej: Cambio en el horario médico, emergencia, conflicto con otra cita..."
              maxlength="500">
            </textarea>
            <div class="char-counter text-muted small">
              {{motivoReagendamiento.length || 0}}/500 caracteres
            </div>
          </div>
        </div>

        <!-- Confirmation Section -->
        <div class="confirmation-section" *ngIf="slotSeleccionado && motivoReagendamiento && motivoReagendamiento.length >= 5">
          <h6><i class="fas fa-check-circle"></i> Confirmar Reagendamiento</h6>
          
          <div class="row">
            <div class="col-md-5">
              <div class="change-from">
                <small class="text-muted">Cambiar de:</small>
                <div class="appointment-summary old">
                  <i class="fas fa-calendar-minus"></i>
                  <div>
                    <strong>{{formatDate(selectedTurno?.fecha || '')}}</strong><br>
                    <span>{{selectedTurno?.horaInicio}} - {{selectedTurno?.horaFin}}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-2 text-center">
              <div class="change-arrow">
                <i class="fas fa-arrow-right fa-2x text-primary"></i>
              </div>
            </div>
            
            <div class="col-md-5">
              <div class="change-to">
                <small class="text-muted">Cambiar a:</small>
                <div class="appointment-summary new">
                  <i class="fas fa-calendar-plus"></i>
                  <div>
                    <strong>{{formatDate(slotSeleccionado.fecha)}}</strong><br>
                    <span>{{slotSeleccionado.horaInicio}} - {{slotSeleccionado.horaFin}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Messages -->
        <div class="alert alert-danger" *ngIf="errorMessageReagendar">
          <i class="fas fa-exclamation-triangle"></i>
          {{errorMessageReagendar}}
        </div>

        <!-- Processing Message -->
        <div class="alert alert-info" *ngIf="isProcessingReagendar">
          <i class="fas fa-spinner fa-spin"></i>
          Procesando reagendamiento...
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelarSeleccionSlot()" 
                *ngIf="slotSeleccionado" [disabled]="isProcessingReagendar">
          <i class="fas fa-times"></i>
          Cancelar Selección
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeReagendarModal()" 
                [disabled]="isProcessingReagendar">
          Cerrar
        </button>
        <button type="button" class="btn btn-primary" (click)="confirmarReagendamiento()" 
                *ngIf="slotSeleccionado && motivoReagendamiento && motivoReagendamiento.length >= 5"
                [disabled]="isProcessingReagendar">
          <span *ngIf="isProcessingReagendar" class="spinner-border spinner-border-sm me-1"></span>
          <i *ngIf="!isProcessingReagendar" class="fas fa-calendar-check"></i>
          Confirmar Reagendamiento
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal de reagendamiento -->
<div class="modal-backdrop fade" [class.show]="showReagendarModal" *ngIf="showReagendarModal"></div>
