<div class="container-fluid px-3 py-4" *ngIf="operador">
  <div class="card shadow-lg rounded-4 overflow-hidden border-0">
    <div
      class="card-header bg-gradient-blue text-white position-relative py-4 px-5"
    >
      <div class="gradient-overlay"></div>
      <div class="position-relative">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <div class="icon-container me-4">
              <i class="fas fa-user-cog icon-main"></i>
            </div>
            <div>
              <h1 class="mb-1 fw-bold display-6" *ngIf="!esNuevo()">
                {{ operador.nombre }} {{ operador.apellido }}
              </h1>
              <h1 class="mb-1 fw-bold display-6" *ngIf="esNuevo()">
                Nuevo Operador
              </h1>
              <p class="mb-0 opacity-75">
                <ng-container *ngIf="!modoEdicion && !esNuevo()"
                  >Información del operador</ng-container
                >
                <ng-container *ngIf="modoEdicion && !esNuevo()"
                  >Editando información</ng-container
                >
                <ng-container *ngIf="esNuevo()"
                  >Registro de nuevo operador</ng-container
                >
              </p>
            </div>
          </div>
          <div class="d-flex gap-2" *ngIf="!modoEdicion && !esNuevo()">
            <button
              class="btn btn-glass rounded-pill px-4"
              (click)="activarEdicion()"
            >
              <i class="fas fa-edit me-2"></i>
              <span class="d-none d-sm-inline">Editar</span>
            </button>
            <button
              class="btn btn-glass-secondary rounded-pill px-4"
              (click)="goBack()"
            >
              <i class="fas fa-arrow-left me-2"></i>
              <span class="d-none d-sm-inline">Volver</span>
            </button>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2" *ngIf="!modoEdicion && !esNuevo()">
          <span class="badge badge-glass">
            <i class="fas fa-hashtag me-1"></i>
            ID: {{ operador.id }}
          </span>
          <span class="badge badge-glass">
            <i class="fas fa-user-check me-1"></i>
            Activo: {{ operador.activo ? "Sí" : "No" }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-body p-5">
      <!-- MODO VISTA -->
      <div *ngIf="!modoEdicion && !esNuevo()" class="row g-4">
        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon"><i class="fas fa-user"></i></div>
            <div>
              <label class="info-label">Nombre Completo</label>
              <div class="info-value">
                {{ operador.nombre }} {{ operador.apellido }}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon"><i class="fas fa-envelope"></i></div>
            <div>
              <label class="info-label">Email</label>
              <div class="info-value">{{ operador.email }}</div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="info-card">
            <div class="info-icon"><i class="fas fa-phone"></i></div>
            <div>
              <label class="info-label">Teléfono</label>
              <div class="info-value">{{ operador.telefono || "-" }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- MODO EDICIÓN/CREACIÓN -->
      <form
        *ngIf="modoEdicion || esNuevo()"
        #form="ngForm"
        (ngSubmit)="save()"
        class="needs-validation"
        novalidate
      >
        <div class="row g-4">
          <!-- Nombre -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="operador.nombre"
                name="nombre"
                id="nombre"
                class="form-control form-control-modern"
                placeholder="Nombre"
                required
                #nombre="ngModel"
              />
              <label for="nombre"><i class="fas fa-user me-2"></i>Nombre</label>
            </div>
            <div
              *ngIf="isInvalidField(nombre)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>El nombre es
              requerido
            </div>
          </div>

          <!-- Apellido -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="operador.apellido"
                name="apellido"
                id="apellido"
                class="form-control form-control-modern"
                placeholder="Apellido"
                required
                #apellido="ngModel"
              />
              <label for="apellido"
                ><i class="fas fa-user-tag me-2"></i>Apellido</label
              >
            </div>
            <div
              *ngIf="isInvalidField(apellido)"
              class="invalid-feedback d-block"
            >
              <i class="fas fa-exclamation-circle me-1"></i>El apellido es
              requerido
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="operador.email"
                name="email"
                id="email"
                type="email"
                class="form-control form-control-modern"
                placeholder="Email"
                required
                #email="ngModel"
              />
              <label for="email"
                ><i class="fas fa-envelope me-2"></i>Email</label
              >
            </div>
            <div *ngIf="isInvalidField(email)" class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-1"></i>
              <div *ngIf="email.errors?.['required']">
                El email es requerido
              </div>
              <div *ngIf="email.errors?.['email']">
                Debe ser un email válido
              </div>
            </div>
          </div>

          <!-- DNI -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="operador.dni"
                name="dni"
                id="dni"
                type="text"
                class="form-control form-control-modern"
                placeholder="DNI"
                required
                #dni="ngModel"
              />
              <label for="dni"><i class="fas fa-id-card me-2"></i>DNI</label>
            </div>
            <div *ngIf="isInvalidField(dni)" class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-1"></i>El DNI es requerido
            </div>
          </div>

          <!-- Teléfono -->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                [(ngModel)]="operador.telefono"
                name="telefono"
                id="telefono"
                class="form-control form-control-modern"
                placeholder="Teléfono"
                #telefono="ngModel"
              />
              <label for="telefono"
                ><i class="fas fa-phone me-2"></i>Teléfono</label
              >
            </div>
          </div>

          <!-- Activo switch -->
          <div class="col-md-6 d-flex align-items-center">
            <div class="form-check form-switch">
              <input
                type="checkbox"
                class="form-check-input"
                id="activo"
                [(ngModel)]="operador.activo"
                name="activo"
              />
              <label class="form-check-label" for="activo">Activo</label>
            </div>
          </div>

          <!-- Información sobre contraseña automática para nuevos operadores -->
          <div class="col-md-12" *ngIf="esNuevo()">
            <div class="alert alert-info d-flex align-items-center">
              <i class="fas fa-info-circle me-3"></i>
              <div>
                <strong>Contraseña automática:</strong>
                Se generará una contraseña segura automáticamente y será enviada
                por correo electrónico al operador.
              </div>
            </div>
          </div>

          <!-- Contraseña: solo para edición cuando se activa el cambio -->
          <div class="col-md-12" *ngIf="!esNuevo() && cambiarPassword">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    [(ngModel)]="password"
                    name="password"
                    id="password"
                    type="password"
                    class="form-control form-control-modern"
                    placeholder="Contraseña"
                    required
                    minlength="6"
                    #pwd="ngModel"
                  />
                  <label for="password"
                    ><i class="fas fa-lock me-2"></i>Nueva Contraseña</label
                  >
                </div>
                <div
                  *ngIf="pwd?.invalid && (pwd.dirty || pwd.touched)"
                  class="invalid-feedback d-block"
                >
                  <div *ngIf="pwd.errors?.['required']">
                    La contraseña es requerida
                  </div>
                  <div *ngIf="pwd.errors?.['minlength']">
                    La contraseña debe tener al menos 6 caracteres
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    [(ngModel)]="confirmPassword"
                    name="confirmPassword"
                    id="confirmPassword"
                    type="password"
                    class="form-control form-control-modern"
                    placeholder="Confirmar contraseña"
                    required
                    #cpwd="ngModel"
                  />
                  <label for="confirmPassword"
                    ><i class="fas fa-lock me-2"></i>Confirmar contraseña</label
                  >
                </div>
                <div
                  *ngIf="
                    confirmPassword &&
                    password !== confirmPassword &&
                    (cpwd.dirty || cpwd.touched)
                  "
                  class="invalid-feedback d-block"
                >
                  ⚠️ Las contraseñas no coinciden
                </div>
              </div>
            </div>
          </div>

          <!-- Toggle cambiar password (solo en edición) -->
          <div class="col-12" *ngIf="!esNuevo()">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="toggleCambiarPassword()"
            >
              <i
                class="fas"
                [class.fa-key]="!cambiarPassword"
                [class.fa-times]="cambiarPassword"
              ></i>
              {{
                cambiarPassword
                  ? "Cancelar cambio de contraseña"
                  : "Cambiar contraseña"
              }}
            </button>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex flex-wrap gap-3 mt-5 pt-4 border-top">
          <button
            type="submit"
            class="btn btn-modern btn-primary rounded-pill px-5 py-3 fw-bold"
            [disabled]="
              form.invalid ||
              (!esNuevo() && cambiarPassword && passwordMismatch())
            "
          >
            <i class="fas fa-save me-2"></i>
            <span *ngIf="esNuevo()">Crear Operador</span>
            <span *ngIf="!esNuevo()">Guardar Cambios</span>
          </button>

          <button
            type="button"
            class="btn btn-secondary-gradient btn-lg rounded-pill px-4"
            (click)="cancelar()"
          >
            <i class="fas fa-times me-2"></i>Cancelar
          </button>

          <button
            *ngIf="operador.id && !esNuevo()"
            type="button"
            class="btn btn-danger-gradient btn-lg rounded-pill px-4"
            (click)="confirmDelete()"
          >
            <i class="fas fa-trash me-2"></i>Eliminar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
