<div class="container-fluid py-4">
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="display-6 mb-2">
          <i class="fas fa-calendar-times text-warning me-3"></i>
          Gestión de Días Excepcionales
        </h1>
        <p class="text-muted mb-0">
          Configure feriados, mantenimiento y horarios especiales
        </p>
      </div>
      <button class="btn btn-primary btn-lg" (click)="abrirModalNuevo()">
        <i class="fas fa-plus me-2"></i>Agregar Día Excepcional
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="card-title mb-0">
        <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Centro de Atención</label>
          <select
            class="form-select"
            [(ngModel)]="filtros.centroId"
            (change)="aplicarFiltros()"
          >
            <option value="">Todos los centros</option>
            <option *ngFor="let centro of centros" [value]="centro.id">
              {{ centro.nombre }}
            </option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Tipo</label>
          <select
            class="form-select"
            [(ngModel)]="filtros.tipo"
            (change)="aplicarFiltros()"
          >
            <option value="">Todos los tipos</option>
            <option value="FERIADO">Feriado</option>
            <option value="ATENCION_ESPECIAL">Atención Especial</option>
            <option value="MANTENIMIENTO">Mantenimiento</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Año</label>
          <select
            class="form-select"
            [(ngModel)]="filtros.anio"
            (change)="aplicarFiltros()"
          >
            <option *ngFor="let anio of anios" [value]="anio">
              {{ anio }}
            </option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de días excepcionales -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h5 class="card-title mb-0">
        <i class="fas fa-list me-2"></i>Días Excepcionales Configurados
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Centro/Consultorio</th>
              <th>Horario</th>
              <th>Duración</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let dia of diasFiltrados" class="align-middle">
              <td>
                <strong>{{ dia.fecha | date : "dd/MM/yyyy" }}</strong>
                <br />
                <small class="text-muted">{{
                  dia.fecha | date : "EEEE"
                }}</small>
              </td>
              <td>
                <span
                  class="badge fs-6"
                  [ngClass]="getTipoBadgeClass(dia.tipo)"
                >
                  <i
                    class="fas"
                    [ngClass]="getTipoIcon(dia.tipo)"
                    class="me-1"
                  ></i>
                  {{ getTipoLabel(dia.tipo) }}
                </span>
              </td>
              <td class="descripcion-cell">
                <div class="descripcion-text">{{ dia.descripcion }}</div>
                <!-- Mostrar tipo de procedimiento si es atención especial -->
                <div
                  *ngIf="
                    dia.tipo === 'ATENCION_ESPECIAL' &&
                    dia.descripcion &&
                    getTipoProcedimientoFromDescription(dia.descripcion)
                  "
                  class="mt-1"
                >
                  <small class="badge bg-secondary">
                    <i class="fas fa-medical-kit me-1"></i>
                    {{
                      getTipoProcedimientoLabel(
                        getTipoProcedimientoFromDescription(dia.descripcion)!
                      )
                    }}
                  </small>
                </div>
              </td>
              <td>
                <div *ngIf="dia.centroNombre" class="centro-info">
                  <strong>{{ dia.centroNombre }}</strong>
                  <br />
                  <small class="text-muted" *ngIf="dia.consultorioNombre">
                    <i class="fas fa-door-open me-1"></i
                    >{{ dia.consultorioNombre }}
                  </small>
                  <br />
                  <small class="text-muted" *ngIf="dia.medicoNombre">
                    <i class="fas fa-user-md me-1"></i>Dr.
                    {{ dia.medicoNombre }} {{ dia.medicoApellido }}
                    <span *ngIf="dia.especialidad" class="d-block">
                      <i class="fas fa-stethoscope me-1"></i
                      >{{ dia.especialidad }}
                    </span>
                  </small>
                </div>
                <div *ngIf="!dia.centroNombre">
                  <span class="badge bg-info text-dark">
                    <i class="fas fa-globe me-1"></i>General
                  </span>
                  <br />
                  <small class="text-muted">(Todos los centros)</small>
                </div>
              </td>
              <td>
                <div *ngIf="dia.apertura && dia.cierre">
                  <i class="fas fa-clock me-1"></i>
                  {{ dia.apertura }} - {{ dia.cierre }}
                  <!-- Mostrar duración si es atención especial -->
                  <div *ngIf="dia.tipo === 'ATENCION_ESPECIAL'" class="mt-1">
                    <small class="badge bg-info">
                      <i class="fas fa-stopwatch me-1"></i>
                      {{ calcularDuracion(dia.apertura, dia.cierre) }} min
                    </small>
                  </div>
                </div>
                <div *ngIf="!dia.apertura">
                  <span class="text-muted">Todo el día</span>
                </div>
              </td>
              <td>
                <div *ngIf="dia.duracion">
                  <i class="fas fa-clock me-1"></i>
                  {{ dia.duracion }} min
                </div>
                <div *ngIf="!dia.duracion">
                  <span class="text-muted">-</span>
                </div>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" (click)="editar(dia)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn btn-outline-danger"
                    (click)="eliminar(dia)"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="diasFiltrados.length === 0">
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="fas fa-calendar-times fa-3x mb-3 opacity-50"></i>
                <p class="mb-0">No hay días excepcionales configurados</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar día excepcional -->
  <div
    class="modal fade"
    [class.show]="showModal"
    [style.display]="showModal ? 'block' : 'none'"
    tabindex="-1"
    *ngIf="showModal"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-calendar-plus me-2"></i>
            {{ editando ? "Editar" : "Agregar" }} Día Excepcional
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="cerrarModal()"
          ></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="guardar()" #form="ngForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Fecha *</label>
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="diaActual.fecha"
                  name="fecha"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Tipo *</label>
                <select
                  class="form-select"
                  [(ngModel)]="diaActual.tipo"
                  name="tipo"
                  required
                  (change)="onTipoChange()"
                >
                  <option value="">Seleccione un tipo</option>
                  <option value="FERIADO">Feriado</option>
                  <option value="ATENCION_ESPECIAL">Atención Especial</option>
                  <option value="MANTENIMIENTO">Mantenimiento</option>
                </select>
              </div>
              <!-- Descripción general para feriados -->
              <div class="col-12" *ngIf="diaActual.tipo === 'FERIADO'">
                <label class="form-label">Descripción *</label>
                <textarea
                  class="form-control"
                  [(ngModel)]="diaActual.descripcionExcepcion"
                  name="descripcion"
                  required
                  rows="2"
                  placeholder="Ej: Día del Trabajador, Día de la Independencia, etc."
                ></textarea>
              </div>

              <!-- Solo para mantenimiento y atención especial -->
              <div class="col-12" *ngIf="diaActual.tipo !== 'FERIADO'">
                <label class="form-label">Esquema de Turno *</label>
                <select
                  class="form-select"
                  [(ngModel)]="diaActual.esquemaTurnoId"
                  name="esquemaTurno"
                  required
                  (change)="onEsquemaTurnoChange()"
                >
                  <option value="">Seleccione un esquema</option>
                  <option
                    *ngFor="let esquema of esquemasTurno"
                    [value]="esquema.id"
                  >
                    {{ esquema.nombreCentro }} -
                    {{ esquema.nombreConsultorio }} - Dr.
                    {{ esquema.nombreStaffMedico }}
                  </option>
                </select>
              </div>

              <!-- Mostrar horarios del esquema de turno seleccionado -->
              <div
                class="col-12"
                *ngIf="diaActual.tipo !== 'FERIADO' && getEsquemaSeleccionado()"
              >
                <div class="esquema-horarios-info">
                  <h6 class="mb-3">
                    <i class="fas fa-clock text-primary me-2"></i>
                    Horarios del Esquema de Turno Seleccionado
                  </h6>
                  <div class="esquema-info-card">
                    <div class="esquema-header">
                      <div class="esquema-details">
                        <div class="detail-item">
                          <i class="fas fa-building text-info me-2"></i>
                          <strong>Centro:</strong>
                          {{ getEsquemaSeleccionado()?.nombreCentro }}
                        </div>
                        <div class="detail-item">
                          <i class="fas fa-door-open text-warning me-2"></i>
                          <strong>Consultorio:</strong>
                          {{ getEsquemaSeleccionado()?.nombreConsultorio }}
                        </div>
                        <div class="detail-item">
                          <i class="fas fa-user-md text-success me-2"></i>
                          <strong>Médico:</strong> Dr.
                          {{ getEsquemaSeleccionado()?.nombreStaffMedico }}
                        </div>
                        <div class="detail-item">
                          <i
                            class="fas fa-hourglass-half text-secondary me-2"
                          ></i>
                          <strong>Intervalo:</strong>
                          {{ getEsquemaSeleccionado()?.intervalo }} minutos
                        </div>
                      </div>
                    </div>

                    <div
                      class="horarios-container"
                      *ngIf="
                        getEsquemaSeleccionado()?.horarios &&
                          getEsquemaSeleccionado()?.horarios.length > 0;
                        else noHorarios
                      "
                    >
                      <div class="horarios-grid">
                        <div
                          *ngFor="
                            let horario of getEsquemaSeleccionado()?.horarios
                          "
                          class="horario-badge"
                        >
                          <span class="dia-label">{{ horario.dia }}</span>
                          <span class="hora-label"
                            >{{ horario.horaInicio }} -
                            {{ horario.horaFin }}</span
                          >
                        </div>
                      </div>
                    </div>

                    <ng-template #noHorarios>
                      <div class="no-horarios-warning">
                        <i
                          class="fas fa-exclamation-triangle text-warning me-2"
                        ></i>
                        Este esquema de turno no tiene horarios configurados
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>

              <!-- Campos específicos para atención especial -->
              <ng-container *ngIf="diaActual.tipo === 'ATENCION_ESPECIAL'">
                <div class="col-md-4">
                  <label class="form-label">Hora de Inicio *</label>
                  <input
                    type="time"
                    class="form-control"
                    [(ngModel)]="diaActual.horaInicio"
                    name="horaInicio"
                    required
                  />
                  <small class="form-text text-muted"
                    >Hora exacta de inicio del procedimiento</small
                  >
                </div>
                <div class="col-md-4">
                  <label class="form-label">Duración (minutos) *</label>
                  <input
                    type="number"
                    class="form-control"
                    [(ngModel)]="diaActual.duracionMinutos"
                    name="duracionMinutos"
                    required
                    min="15"
                    max="480"
                    step="15"
                    placeholder="Ej: 60"
                  />
                  <small class="form-text text-muted"
                    >Duración total del procedimiento</small
                  >
                </div>
                <div class="col-md-4">
                  <label class="form-label">Tipo de Procedimiento *</label>
                  <select
                    class="form-select"
                    [(ngModel)]="diaActual.tipoProcedimiento"
                    name="tipoProcedimiento"
                    required
                  >
                    <option value="">Seleccionar tipo</option>
                    <option value="CIRUGIA">Cirugía</option>
                    <option value="ESTUDIO">Estudio Médico</option>
                    <option value="PROCEDIMIENTO_ESPECIAL">
                      Procedimiento Especial
                    </option>
                    <option value="CONSULTA_EXTENDIDA">
                      Consulta Extendida
                    </option>
                    <option value="INTERCONSULTA">Interconsulta</option>
                  </select>
                  <small class="form-text text-muted"
                    >Categoría del procedimiento reservado</small
                  >
                </div>
                <div class="col-12">
                  <label class="form-label"
                    >Descripción del Procedimiento *</label
                  >
                  <textarea
                    class="form-control"
                    [(ngModel)]="diaActual.descripcionExcepcion"
                    name="descripcionExcepcion"
                    required
                    rows="3"
                    placeholder="Ej: Cirugía de apendicitis - Paciente Juan Pérez"
                  ></textarea>
                  <small class="form-text text-muted"
                    >Descripción detallada del procedimiento o motivo de la
                    reserva</small
                  >
                </div>
              </ng-container>

              <!-- Campos específicos para mantenimiento -->
              <ng-container *ngIf="diaActual.tipo === 'MANTENIMIENTO'">
                <div class="col-md-6">
                  <label class="form-label"
                    >Hora de Inicio del Mantenimiento *</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    [(ngModel)]="diaActual.horaInicio"
                    name="horaInicioMantenimiento"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Duración Adicional (minutos)</label>
                  <input
                    type="number"
                    class="form-control"
                    [(ngModel)]="diaActual.duracion"
                    name="duracion"
                    min="0"
                    max="60"
                    placeholder="Ej: 15"
                  />
                  <small class="form-text text-muted"
                    >Tiempo adicional después del mantenimiento</small
                  >
                </div>
                <div class="col-12">
                  <label class="form-label"
                    >Descripción del Mantenimiento *</label
                  >
                  <textarea
                    class="form-control"
                    [(ngModel)]="diaActual.descripcionExcepcion"
                    name="descripcionMantenimiento"
                    required
                    rows="2"
                    placeholder="Ej: Mantenimiento sistema eléctrico, Reparación equipos médicos, etc."
                  ></textarea>
                  <small class="form-text text-muted"
                    >Descripción detallada del tipo de mantenimiento a
                    realizar</small
                  >
                </div>
              </ng-container>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cerrarModal()"
          >
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="guardar()"
            [disabled]="!form.valid"
          >
            <i class="fas fa-save me-2"></i
            >{{ editando ? "Actualizar" : "Guardar" }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showModal"></div>
</div>
