<div class="modal-header">
    <h4 class="modal-title">
        {{ data ? 'Editar' : 'Nueva' }} Solicitud en Lista de Espera
    </h4>
    <button type="button" class="close" aria-label="Close" (click)="cerrar()">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="modal-body">
    <form [formGroup]="form">
        <!-- Búsqueda de Paciente -->
        <div class="form-group">
            <label for="searchPaciente">Paciente*</label>

            <!-- Input de búsqueda -->
            <div class="patient-search-wrapper" *ngIf="!isPatientMode">
                <input type="text" class="form-control" id="searchPaciente" [value]="searchTerm"
                    (input)="onSearchPaciente($event)" (focus)="onFocusSearch()" (blur)="onBlurSearch()"
                    placeholder="Buscar por nombre, apellido o DNI..." autocomplete="off"
                    [disabled]="pacienteSeleccionado !== null" />

                <!-- Botón para limpiar selección -->
                <button type="button" class="btn-clear-search" *ngIf="pacienteSeleccionado"
                    (click)="limpiarSeleccionPaciente()" title="Cambiar paciente">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Indicador de carga -->
                <div class="search-spinner" *ngIf="buscandoPacientes">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>

                <!-- Resultados de búsqueda -->
                <div class="search-results" *ngIf="showSearchResults && !buscandoPacientes">
                    <div class="search-result-item" *ngFor="let paciente of pacientesBuscados"
                        (click)="seleccionarPaciente(paciente)">
                        <div class="result-name">
                            <i class="fas fa-user"></i>
                            {{ paciente.nombre }} {{ paciente.apellido }}
                        </div>
                        <div class="result-details">
                            <span class="badge badge-secondary">DNI: {{ paciente.dni }}</span>
                            <span class="badge badge-info" *ngIf="paciente.email">{{ paciente.email }}</span>
                        </div>
                    </div>

                    <!-- Sin resultados -->
                    <div class="no-results" *ngIf="pacientesBuscados.length === 0">
                        <i class="fas fa-search"></i>
                        <p>No se encontraron pacientes con ese criterio</p>
                        <small>Intenta buscar por nombre, apellido o DNI</small>
                    </div>
                </div>

                <!-- Paciente seleccionado (badge) -->
                <div class="selected-patient-badge" *ngIf="pacienteSeleccionado">
                    <i class="fas fa-check-circle"></i>
                    <strong>{{ pacienteSeleccionado.nombre }} {{ pacienteSeleccionado.apellido }}</strong>
                    <span class="text-muted">DNI: {{ pacienteSeleccionado.dni }}</span>
                </div>
            </div>

            <!-- Modo paciente (deshabilitado y autocompleto) -->
            <div *ngIf="isPatientMode">
                <select class="form-control" id="pacienteId" formControlName="pacienteId">
                    <option *ngFor="let paciente of pacientes" [value]="paciente.id">
                        {{ paciente.nombre }} {{ paciente.apellido }} - DNI: {{ paciente.dni || 'No disponible' }}
                    </option>
                </select>
            </div>

            <small class="form-text text-muted" *ngIf="!isPatientMode && !pacienteSeleccionado">
                Escribe al menos 2 caracteres para buscar
            </small>
        </div>

        <!-- Especialidad -->
        <div class="form-group">
            <label for="especialidadId">Especialidad*</label>
            <select class="form-control" id="especialidadId" formControlName="especialidadId" required>
                <option value="">Seleccione una especialidad</option>
                <option *ngFor="let esp of especialidades" [value]="esp.id">
                    {{ esp.nombre }}
                </option>
            </select>
        </div>

        <!-- Centro de Atención -->
        <div class="form-group">
            <label for="centroAtencionId">Centro de Atención*</label>
            <select class="form-control" id="centroAtencionId" formControlName="centroAtencionId" required>
                <option value="">Seleccione un centro</option>
                <option *ngFor="let centro of centros" [value]="centro.id">
                    {{ centro.nombre }}
                </option>
            </select>
        </div>

        <!-- Médico preferido -->
        <div class="form-group">
            <label for="medicoId">Médico Preferido</label>
            <select class="form-control" id="medicoId" formControlName="medicoId">
                <option value="">Sin preferencia</option>
                <option *ngFor="let medico of medicos" [value]="medico.id">
                    {{ medico.nombre }} {{ medico.apellido }}
                </option>
            </select>
        </div>

        <!-- Fechas deseadas -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="fechaDeseadaDesde">Fecha Deseada Desde</label>
                <input type="date" class="form-control" id="fechaDeseadaDesde" formControlName="fechaDeseadaDesde" />
            </div>
            <div class="form-group col-md-6">
                <label for="fechaDeseadaHasta">Fecha Deseada Hasta</label>
                <input type="date" class="form-control" id="fechaDeseadaHasta" formControlName="fechaDeseadaHasta" />
            </div>
        </div>

        <!-- Nivel de urgencia médica -->
        <div class="form-group">
            <label for="urgenciaMedica">Nivel de Urgencia Médica*</label>
            <select class="form-control" id="urgenciaMedica" formControlName="urgenciaMedica" required>
                <option *ngFor="let nivel of nivelesUrgencia" [value]="nivel.value">
                    {{ nivel.label }}
                </option>
            </select>
            <small class="form-text text-muted">
                Seleccione el nivel de urgencia para esta solicitud
            </small>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="cerrar()">Cancelar</button>
    <button type="button" class="btn btn-primary" (click)="guardar()" [disabled]="!form.valid">
        Guardar
    </button>
</div>